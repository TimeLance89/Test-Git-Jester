{% extends "layout.html" %}
{% block title %}Systemeinstellungen{% endblock %}
{% block content %}
<div class="settings-page">
  <header class="settings-hero">
    <div class="settings-hero-content">
      <span class="settings-eyebrow">Systembereich</span>
      <h1>Systemeinstellungen</h1>
      <p>
        Konfigurieren Sie modulare Plattformfunktionen, definieren Sie Arbeitsmodelle und
        behalten Sie Infrastruktur-Integrationen im Blick. Alle Anpassungen sind mandantenfähig
        und für den Einsatz im eigenen Unternehmensnetzwerk vorbereitet.
      </p>
      <div class="settings-meta">
        <span>Nur für Systemadministratoren sichtbar</span>
        <span>Letzte Aktualisierung: {{ last_updated.strftime('%d.%m.%Y %H:%M') }} Uhr · Bereit für On-Premises</span>
      </div>
    </div>
    <div class="settings-hero-stats" role="group" aria-label="Systemstatus">
      {% for stat in stats %}
      <div class="settings-stat">
        <div class="settings-stat-value">{{ stat.value }}</div>
        <div class="settings-stat-label">{{ stat.label }}</div>
      </div>
      {% endfor %}
    </div>
  </header>

  <section class="settings-quick-actions" aria-label="Direktaktionen">
    <div class="settings-section-header">
      <h2>Direktaktionen</h2>
      <p>Beschleunigen Sie zentrale Verwaltungsaufgaben für neue Mandanten und Standorte.</p>
    </div>
    <div class="settings-quick-grid">
      {% for action in quick_actions %}
      {% set is_link = action.href is defined and action.href %}
      {% set is_live = action.state == 'Verfügbar' %}
      {% if is_link %}
      <a
        href="{{ action.href }}"
        class="settings-quick-action{% if is_live %} settings-quick-action--live{% endif %}"
        data-action="{{ action.id }}"
      >
      {% else %}
      <button
        type="button"
        class="settings-quick-action{% if is_live %} settings-quick-action--live{% endif %}"
        data-action="{{ action.id }}"
        title="Funktion wird in Kürze verfügbar sein"
      >
      {% endif %}
        <span class="settings-quick-icon" aria-hidden="true">{{ action.icon }}</span>
        <span class="settings-quick-content">
          <span class="settings-quick-title">{{ action.title }}</span>
          <span class="settings-quick-description">{{ action.description }}</span>
        </span>
        {% if action.state %}
        <span class="settings-quick-hint{% if is_live %} settings-quick-hint--live{% endif %}">{{ action.state }}</span>
        {% endif %}
      {% if is_link %}
      </a>
      {% else %}
      </button>
      {% endif %}
      {% endfor %}
    </div>
  </section>

  <section class="settings-automation-callout" aria-label="Automatisierte Freigaben">
    <div class="automation-callout-content">
      <div>
        <h2>Automatisierte Freigaben</h2>
        <p>
          Definieren Sie intelligente Regeln, die offene Einsätze und Abwesenheiten zu festen Zeiten prüfen und
          genehmigen. Benachrichtigungen informieren Teams automatisch über neue Entscheidungen.
        </p>
        <ul class="automation-callout-list">
          <li>Mehrstufige Zeitpläne mit täglichen, wöchentlichen oder einmaligen Abläufen</li>
          <li>Automatische Benachrichtigungen für Mitarbeitende und Administratoren</li>
          <li>Transparente Historie mit Protokoll über die letzte Ausführung</li>
        </ul>
      </div>
      <a class="btn-primary" href="{{ url_for('automated_approvals') }}">Automationen verwalten</a>
    </div>
  </section>

  <section class="settings-grid">
    <div class="settings-column">
      <article class="settings-card settings-card--form" id="work-class-manager">
        <header class="settings-card-header">
          <div>
            <h3>Arbeitsklassen</h3>
            <p>Standardisierte Arbeitszeitmodelle für wiederkehrende Einsatzpläne.</p>
          </div>
          <span class="settings-chip">
            {{ active_work_classes|length }} aktiv
            {% if inactive_work_classes %}
              · {{ inactive_work_classes|length }} pausiert
            {% endif %}
          </span>
        </header>

        <form method="post" action="{{ url_for('create_work_class') }}" class="work-class-form">
          <div class="work-class-form-grid">
            <label>
              <span>Bezeichnung</span>
              <input type="text" name="name" placeholder="z. B. Vollzeit" required>
            </label>
            <label>
              <span>Wochenstunden</span>
              <input type="number" name="hours_per_week" step="0.5" min="0" placeholder="40">
            </label>
            <label>
              <span>Monatsstunden</span>
              <input type="number" name="hours_per_month" step="0.5" min="0" placeholder="160">
            </label>
            <label>
              <span>Farbcode</span>
              <input type="text" name="color" placeholder="#1d4ed8">
            </label>
          </div>
          <label class="work-class-textarea">
            <span>Beschreibung</span>
            <textarea name="description" rows="2" placeholder="Optionaler Hinweis für Teams"></textarea>
          </label>
          <label class="work-class-checkbox">
            <input type="checkbox" name="is_default">
            <span>Als Standard-Arbeitsklasse festlegen</span>
          </label>
          <div class="work-class-action-row">
            <button type="submit" class="btn-primary">Arbeitsklasse anlegen</button>
          </div>
        </form>

        {% if recommended_work_classes %}
        <div class="work-class-suggestions" role="group" aria-label="Vorlagen für Arbeitsklassen">
          <span>Vorlagen übernehmen:</span>
          <div class="work-class-suggestion-list">
            {% for suggestion in recommended_work_classes %}
            <form method="post" action="{{ url_for('create_work_class') }}" class="work-class-suggestion">
              <input type="hidden" name="name" value="{{ suggestion.name }}">
              <input type="hidden" name="hours_per_week" value="{{ suggestion.hours_per_week }}">
              <input type="hidden" name="hours_per_month" value="{{ suggestion.hours_per_month }}">
              <input type="hidden" name="description" value="{{ suggestion.description }}">
              {% if suggestion.color %}<input type="hidden" name="color" value="{{ suggestion.color }}">{% endif %}
              <button type="submit">{{ suggestion.name }}</button>
            </form>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <div class="work-class-list">
          {% if work_classes %}
          <ul class="work-class-accordion">
            {% for work_class in work_classes %}
            <li class="work-class-item">
              <details class="work-class-panel"{% if work_class.is_default %} open{% endif %}>
                <summary class="work-class-summary">
                  <span class="work-class-summary-main">
                    {% if work_class.color %}
                    <span class="work-class-color" style="background: {{ work_class.color }}" aria-hidden="true"></span>
                    {% endif %}
                    {{ work_class.name }}
                  </span>
                  <span class="work-class-summary-meta">
                    {% if work_class.hours_per_week is not none %}
                    <span class="work-class-hours">{{ '{:g}'.format(work_class.hours_per_week) }} h/Woche</span>
                    {% endif %}
                    {% if work_class.hours_per_month is not none %}
                    <span class="work-class-hours">{{ '{:g}'.format(work_class.hours_per_month) }} h/Monat</span>
                    {% endif %}
                    {% if work_class.is_default %}
                    <span class="work-class-badge">Standard</span>
                    {% endif %}
                    {% if not work_class.is_active %}
                    <span class="work-class-badge work-class-badge--inactive">Pausiert</span>
                    {% endif %}
                  </span>
                </summary>
                <div class="work-class-detail-body">
                  <form method="post" action="{{ url_for('update_work_class', class_id=work_class.id) }}" class="work-class-edit-form">
                    <div class="work-class-form-grid">
                      <label>
                        <span>Bezeichnung</span>
                        <input type="text" name="name" value="{{ work_class.name }}" required>
                      </label>
                      <label>
                        <span>Wochenstunden</span>
                        <input type="number" name="hours_per_week" step="0.5" min="0" value="{{ work_class.hours_per_week if work_class.hours_per_week is not none else '' }}">
                      </label>
                      <label>
                        <span>Monatsstunden</span>
                        <input type="number" name="hours_per_month" step="0.5" min="0" value="{{ work_class.hours_per_month if work_class.hours_per_month is not none else '' }}">
                      </label>
                      <label>
                        <span>Farbcode</span>
                        <input type="text" name="color" value="{{ work_class.color or '' }}" placeholder="#1d4ed8">
                      </label>
                    </div>
                    <label class="work-class-checkbox">
                      <input type="checkbox" name="is_default"{% if work_class.is_default %} checked{% endif %}>
                      <span>Als Standard-Arbeitsklasse verwenden</span>
                    </label>
                    <label class="work-class-textarea">
                      <span>Beschreibung</span>
                      <textarea name="description" rows="2" placeholder="Optionaler Hinweis für Teams">{{ work_class.description or '' }}</textarea>
                    </label>
                    <div class="work-class-action-row">
                      <button type="submit" class="btn-primary">Änderungen speichern</button>
                    </div>
                  </form>
                  <div class="work-class-secondary-actions">
                    <form method="post" action="{{ url_for('toggle_work_class', class_id=work_class.id) }}">
                      <button type="submit" class="btn-secondary">
                        {% if work_class.is_active %}Deaktivieren{% else %}Reaktivieren{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('set_default_work_class', class_id=work_class.id) }}">
                      <button type="submit" class="btn-secondary" {% if work_class.is_default %}disabled{% endif %}>Als Standard setzen</button>
                    </form>
                    <form method="post" action="{{ url_for('delete_work_class', class_id=work_class.id) }}" onsubmit="return confirm('Arbeitsklasse {{ work_class.name }} wirklich löschen?');">
                      <button type="submit" class="btn-ghost">Löschen</button>
                    </form>
                  </div>
                </div>
              </details>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="work-class-empty">Noch keine Arbeitsklassen angelegt. Nutzen Sie die Vorlagen oder erstellen Sie Ihr eigenes Modell.</p>
          {% endif %}
        </div>
      </article>

      <article class="settings-card">
        <header class="settings-card-header">
          <div>
            <h3>Module &amp; Plattformbereiche</h3>
            <p>Überblick über produktionsreife Module für Unternehmenskunden.</p>
          </div>
          <span class="settings-chip">Live</span>
        </header>
        <ul class="settings-list">
          {% for area in focus_areas %}
          <li>
            <span class="settings-list-icon" aria-hidden="true">{{ area.icon }}</span>
            <span class="settings-list-content">
              <span class="settings-list-title">{{ area.title }}</span>
              <span class="settings-list-description">{{ area.description }}</span>
            </span>
            <span class="settings-status">{{ area.badge }}</span>
          </li>
          {% endfor %}
        </ul>
      </article>

      <article class="settings-card">
        <header class="settings-card-header">
          <div>
            <h3>Roadmap</h3>
            <p>Geplante Erweiterungen für die nächsten Releases.</p>
          </div>
        </header>
        <ul class="settings-roadmap">
          {% for item in roadmap %}
          <li>
            <span class="settings-roadmap-icon" aria-hidden="true">{{ item.icon }}</span>
            <span class="settings-roadmap-content">
              <span class="settings-roadmap-title">{{ item.title }}</span>
              <span class="settings-roadmap-description">{{ item.description }}</span>
            </span>
            <span class="settings-roadmap-time">{{ item.quarter }}</span>
          </li>
          {% endfor %}
        </ul>
      </article>
    </div>

    <div class="settings-column">
      <article class="settings-card">
        <header class="settings-card-header">
          <div>
            <h3>Wartungsfenster</h3>
            <p>Geplante Aufgaben für Plattformstabilität.</p>
          </div>
        </header>
        <ul class="settings-maintenance">
          {% for note in maintenance_notes %}
          <li>
            <span class="settings-maintenance-icon" aria-hidden="true">{{ note.icon }}</span>
            <span class="settings-maintenance-content">
              <span class="settings-maintenance-title">{{ note.title }}</span>
              <span class="settings-maintenance-window">{{ note.window }}</span>
              <span class="settings-maintenance-impact">{{ note.impact }}</span>
            </span>
          </li>
          {% endfor %}
        </ul>
      </article>

      <article class="settings-card settings-card--accent">
        <header class="settings-card-header">
          <div>
            <h3>Audit &amp; Monitoring</h3>
            <p>Transparenz über Systemereignisse.</p>
          </div>
        </header>
        <ul class="settings-audit">
          {% for entry in audit_notes %}
          <li>{{ entry }}</li>
          {% endfor %}
        </ul>
        <div class="settings-note">
          <span aria-hidden="true">ℹ️</span>
          <p>Export-Funktionen und Benachrichtigungen folgen mit dem nächsten Release.</p>
        </div>
      </article>

      <article class="settings-card settings-card--danger">
        <header class="settings-card-header">
          <div>
            <h3>Backup &amp; Wiederherstellung</h3>
            <p>Notfallmaßnahmen für Systemausfälle oder Testläufe.</p>
          </div>
          <span class="settings-chip settings-chip--danger">Nur Super-Admins</span>
        </header>
        <div class="settings-danger-content">
          <p>
            Nutzen Sie den gesicherten Backup-Modus, um Datenbank-Sicherungen zu erstellen, Wiederherstellungen zu prüfen
            oder die Plattform für Teststellungen vollständig zurückzusetzen. Alle Aktionen erfordern eine ausdrückliche
            Bestätigung.
          </p>
          <ul>
            <li>Datenspeicherpfad und aktuelle Größe einsehen</li>
            <li>Vorbereitete Sicherungsleitfäden abrufen</li>
            <li>Datenbank nach schriftlicher Bestätigung leeren</li>
          </ul>
        </div>
        <footer class="settings-card-footer">
          <a class="btn btn-danger" href="{{ url_for('backup_mode') }}">Backup-Modus starten</a>
        </footer>
      </article>
    </div>
  </section>
</div>
{% endblock %}
