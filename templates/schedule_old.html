{% extends "layout.html" %}
{% block title %}Dienstplan{% endblock %}
{% block content %}

<div class="container-fluid px-3">
  <h2>Dienstplan f√ºr {{ month }}.{{ year }}</h2>

  <form method="get" class="row g-3 mb-4">
    <div class="col-auto">
      <label class="form-label" for="month">Monat</label>
      <select class="form-select" id="month" name="month">
        {% for m in range(1, 13) %}
        <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label" for="year">Jahr</label>
      <select class="form-select" id="year" name="year">
        {% for y in range(2020, 2030) %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label" for="department">Abteilung</label>
      <select class="form-select" id="department" name="department">
        <option value="">Alle</option>
        {% for dept in departments %}
        <option value="{{ dept.id }}" {% if dept.id == selected_department %}selected{% endif %}>{{ dept.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto d-flex align-items-end">
      <button type="submit" class="btn btn-primary">Aktualisieren</button>
    </div>
  </form>

  <!-- Desktop Layout: Normale Tabelle (‚â•1200px) -->
  <div class="desktop-schedule d-none d-xl-block">
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead class="table-primary">
          <tr>
            <th rowspan="2" class="text-center align-middle" style="min-width: 120px;">MITARBEITER</th>
            {% for day in month_days %}
            <th class="text-center" style="min-width: 35px; font-size: 0.75rem;">
              {{ day.day }}
              {% set day_data = productivity_data.get(day, {}) %}
              {% if day_data.get("teile", 0) > 0 %}
              <br><small class="productivity-info" 
                       title="Berechnung f√ºr {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivit√§t: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} √ó {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                       style="color: #dc2626; font-weight: bold; cursor: help;">
                ({{ day_data.get("teile", 0)|int }})
              </small>
              {% endif %}
            </th>
            {% endfor %}
            <th rowspan="2" class="text-center align-middle" style="min-width: 60px;">Œ£</th>
          </tr>
          <tr>
            {% for day in month_days %}
            <th class="text-center" style="font-size: 0.6rem;">{{ ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][day.weekday()] }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <!-- Vollzeit Mitarbeiter -->
          {% if vollzeit_employees %}
          <tr>
            <td colspan="{{ month_days|length + 1 }}" class="text-center fw-bold" style="background-color: #3b82f6; color: white; padding: 0.5rem;">
              üëî VOLLZEIT MITARBEITER ({{ vollzeit_employees|length }})
            </td>
          </tr>
          {% for emp in vollzeit_employees %}
          <tr>
            <td class="fw-bold" style="background-color: #eff6ff;">
              <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
            </td>
            {% for day in month_days %}
            {% set leave = leaves.get((emp.id, day)) %}
            {% set shift = shifts.get((emp.id, day)) %}
            {% set blocked_day = blocked_days.get(day) %}
            <td class="text-center p-1" style="font-size: 0.7rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              {% if blocked_day %}
                <div class="badge" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  üö´
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:3] }}</small>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.5rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-center fw-bold" style="background-color: #dbeafe;">
              {% if emp.monthly_hours and emp.monthly_hours >= 160 %}
                {{ employee_totals.get(emp.id, 0) }}h (Vollzeit)
              {% else %}
                {{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}

          <!-- Teilzeit Mitarbeiter -->
          {% if teilzeit_employees %}
          <tr>
            <td colspan="{{ month_days|length + 1 }}" class="text-center fw-bold" style="background-color: #10b981; color: white; padding: 0.5rem;">
              ‚è∞ TEILZEIT MITARBEITER ({{ teilzeit_employees|length }})
            </td>
          </tr>
          {% for emp in teilzeit_employees %}
          <tr>
            <td class="fw-bold" style="background-color: #ecfdf5;">
              <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
            </td>
            {% for day in month_days %}
            {% set leave = leaves.get((emp.id, day)) %}
            {% set shift = shifts.get((emp.id, day)) %}
            {% set blocked_day = blocked_days.get(day) %}
            <td class="text-center p-1" style="font-size: 0.7rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              {% if blocked_day %}
                <div class="badge" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  {{ blocked_day.name[:3] }}
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge mt-1 position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge mt-1 position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark mt-1 position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:3] }}</small>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.5rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-center fw-bold" style="background-color: #d1fae5;">
              {{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}
            </td>
          </tr>
          {% endfor %}
          {% endif %}

          <!-- Aushilfe Mitarbeiter -->
          {% if aushilfe_employees %}
          <tr>
            <td colspan="{{ month_days|length + 1 }}" class="text-center fw-bold" style="background-color: #f59e0b; color: white; padding: 0.5rem;">
              ü§ù AUSHILFE MITARBEITER ({{ aushilfe_employees|length }})
            </td>
          </tr>
          {% for emp in aushilfe_employees %}
          <tr>
            <td class="fw-bold" style="background-color: #fffbeb;">
              <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
            </td>
            {% for day in month_days %}
            {% set leave = leaves.get((emp.id, day)) %}
            {% set shift = shifts.get((emp.id, day)) %}
            {% set blocked_day = blocked_days.get(day) %}
            <td class="text-center p-1" style="font-size: 0.7rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              {% if blocked_day %}
                <div class="badge" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  üö´
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.5rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:3] }}</small>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.5rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-center fw-bold" style="background-color: #fef3c7;">
              {% if emp.monthly_hours and emp.monthly_hours >= 160 %}
                {{ employee_totals.get(emp.id, 0) }}h (Vollzeit)
              {% else %}
                {{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tablet Layout: Wochen-Ansicht (768px-1199px) -->
  <div class="tablet-schedule d-none d-md-block d-xl-none">
    {% set weeks = [] %}
    {% set current_week = [] %}
    {% for day in month_days %}
      {% if day.weekday() == 0 and current_week %}
        {% set _ = weeks.append(current_week) %}
        {% set current_week = [day] %}
      {% else %}
        {% set _ = current_week.append(day) %}
      {% endif %}
    {% endfor %}
    {% if current_week %}
      {% set _ = weeks.append(current_week) %}
    {% endif %}

    {% for week_days in weeks %}
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Woche {{ loop.index }} ({{ week_days[0].day }}.{{ month }} - {{ week_days[-1].day }}.{{ month }}.{{ year }})</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th style="min-width: 100px;">Mitarbeiter</th>
                {% for day in week_days %}
                <th class="text-center" style="min-width: 80px;">
                  {{ ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][day.weekday()] }}<br>
                  <small>{{ day.day }}.{{ month }}
                  {% set day_data = productivity_data.get(day, {}) %}
                  {% if day_data.get("teile", 0) > 0 %}
                  <br><span class="productivity-info" 
                           title="Berechnung f√ºr {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivit√§t: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} √ó {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                           style="color: #dc2626; font-weight: bold; cursor: help;">
                    ({{ day_data.get("teile", 0)|int }})
                  </span>
                  {% endif %}
                  </small>
                </th>
                {% endfor %}
                <th class="text-center" style="min-width: 60px;">Woche Œ£</th>
              </tr>
            </thead>
            <tbody>
              <!-- Vollzeit Mitarbeiter -->
              {% set week_vollzeit_employees = vollzeit_employees %}
              {% if week_vollzeit_employees %}
              <tr>
                <td colspan="{{ week_days|length + 2 }}" class="text-center fw-bold" style="background-color: #3b82f6; color: white; padding: 0.5rem;">
                  üëî VOLLZEIT MITARBEITER ({{ week_vollzeit_employees|length }})
                </td>
              </tr>
              {% for emp in week_vollzeit_employees %}
              <tr>
                <td class="fw-bold" style="background-color: #eff6ff;">
                  <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
                </td>
                {% set week_total = 0 %}
                {% for day in week_days %}
                {% set leave = leaves.get((emp.id, day)) %}
                {% set shift = shifts.get((emp.id, day)) %}
                {% set blocked_day = blocked_days.get(day) %}
                <td class="text-center p-2" style="{% if blocked_day %}background-color: #fee2e2;{% endif %}">
                  {% if blocked_day %}
                    <div class="badge" style="background-color: #dc2626; color: white;" 
                         title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                      üö´
                    </div>
                  {% elif leave %}
                    {% if leave.leave_type == 'Urlaub' %}
                      <div class="badge" style="background-color: orange; color: green;">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% elif leave.leave_type == 'Krank' %}
                      <div class="badge" style="background-color: red; color: white;">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% else %}
                      <div class="badge bg-warning text-dark">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% endif %}
                  {% elif shift %}
                    <div class="badge bg-success" style="color: #000 !important;">
                      {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                    </div>
                    {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:5] }}</small>{% endif %}
                    {% if True %}
                    <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteShift({{ shift.id }})"></button>
                    {% endif %}
                    {% set week_total = week_total + shift.hours %}
                  {% endif %}
                </td>
                {% endfor %}
                <td class="text-center fw-bold" style="background-color: #dbeafe;">{{ week_total }}h</td>
              </tr>
              {% endfor %}
              {% endif %}

              <!-- Teilzeit Mitarbeiter -->
              {% set week_teilzeit_employees = teilzeit_employees %}
              {% if week_teilzeit_employees %}
              <tr>
                <td colspan="{{ week_days|length + 2 }}" class="text-center fw-bold" style="background-color: #10b981; color: white; padding: 0.5rem;">
                  ‚è∞ TEILZEIT MITARBEITER ({{ week_teilzeit_employees|length }})
                </td>
              </tr>
              {% for emp in week_teilzeit_employees %}
              <tr>
                <td class="fw-bold" style="background-color: #ecfdf5;">
                  <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
                </td>
                {% set week_total = 0 %}
                {% for day in week_days %}
                {% set leave = leaves.get((emp.id, day)) %}
                {% set shift = shifts.get((emp.id, day)) %}
                {% set blocked_day = blocked_days.get(day) %}
                <td class="text-center p-2" style="{% if blocked_day %}background-color: #fee2e2;{% endif %}">
                  {% if blocked_day %}
                    <div class="badge" style="background-color: #dc2626; color: white;" 
                         title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                      üö´
                    </div>
                  {% elif leave %}
                    {% if leave.leave_type == 'Urlaub' %}
                      <div class="badge position-relative" style="background-color: orange; color: green;">
                        {{ leave.leave_type[:2] }}
                        <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                                onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                      </div>
                    {% elif leave.leave_type == 'Krank' %}
                      <div class="badge position-relative" style="background-color: red; color: white;">
                        {{ leave.leave_type[:2] }}
                        <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                                onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                      </div>
                    {% else %}
                      <div class="badge bg-warning text-dark position-relative">
                        {{ leave.leave_type[:2] }}
                        <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                                onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                      </div>
                    {% endif %}
                  {% elif shift %}
                    <div class="badge bg-success position-relative" style="color: #000 !important;">
                      {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                    </div>
                    {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:5] }}</small>{% endif %}
                    {% if True %}
                    <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteShift({{ shift.id }})"></button>
                    {% endif %}
                    {% set week_total = week_total + shift.hours %}
                  {% endif %}
                </td>
                {% endfor %}
                <td class="text-center fw-bold" style="background-color: #d1fae5;">{{ week_total }}h</td>
              </tr>
              {% endfor %}
              {% endif %}

              <!-- Aushilfe Mitarbeiter -->
              {% set week_aushilfe_employees = aushilfe_employees %}
              {% if week_aushilfe_employees %}
              <tr>
                <td colspan="{{ week_days|length + 2 }}" class="text-center fw-bold" style="background-color: #f59e0b; color: white; padding: 0.5rem;">
                  ü§ù AUSHILFE MITARBEITER ({{ week_aushilfe_employees|length }})
                </td>
              </tr>
              {% for emp in week_aushilfe_employees %}
              <tr>
                <td class="fw-bold" style="background-color: #fffbeb;">
                  <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-decoration-none">{{ emp.name }}</a>
                </td>
                {% set week_total = 0 %}
                {% for day in week_days %}
                {% set leave = leaves.get((emp.id, day)) %}
                {% set shift = shifts.get((emp.id, day)) %}
                {% set blocked_day = blocked_days.get(day) %}
                <td class="text-center p-2" style="{% if blocked_day %}background-color: #fee2e2;{% endif %}">
                  {% if blocked_day %}
                    <div class="badge" style="background-color: #dc2626; color: white;" 
                         title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                      üö´
                    </div>
                  {% elif leave %}
                    {% if leave.leave_type == 'Urlaub' %}
                      <div class="badge" style="background-color: orange; color: green;">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% elif leave.leave_type == 'Krank' %}
                      <div class="badge" style="background-color: red; color: white;">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% else %}
                      <div class="badge bg-warning text-dark">{{ leave.leave_type[:2] }}</div>
                      <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteLeave({{ leave.id }})"></button>
                    {% endif %}
                  {% elif shift %}
                    <div class="badge bg-success" style="color: #000 !important;">
                      {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                    </div>
                    {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><small style="color: #000 !important;">{{ shift.shift_type[:5] }}</small>{% endif %}
                    {% if True %}
                    <button type="button" class="btn-close btn-close-sm ms-1" onclick="deleteShift({{ shift.id }})"></button>
                    {% endif %}
                    {% set week_total = week_total + shift.hours %}
                  {% endif %}
                </td>
                {% endfor %}
                <td class="text-center fw-bold" style="background-color: #fef3c7;">{{ week_total }}h</td>
              </tr>
              {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Mobile Layout: Karten-Ansicht (<768px) -->
  <div class="mobile-schedule d-block d-md-none">
    
    <!-- Vollzeit Mitarbeiter -->
    {% if vollzeit_employees %}
    <div class="alert alert-primary text-center mb-3" style="background-color: #3b82f6; color: white; border: none;">
      <h5 class="mb-0">üëî VOLLZEIT MITARBEITER ({{ vollzeit_employees|length }})</h5>
    </div>
    {% for emp in vollzeit_employees %}
    <div class="card mb-3" style="border-left: 4px solid #3b82f6;">
      <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #3b82f6;">
        <h6 class="mb-0">
          <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-white text-decoration-none">{{ emp.name }}</a>
        </h6>
        <span class="badge bg-light text-dark">{{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}h</span>
      </div>
      <div class="card-body p-2">
        <div class="row g-1">
          {% for day in month_days %}
          {% set leave = leaves.get((emp.id, day)) %}
          {% set shift = shifts.get((emp.id, day)) %}
          {% set blocked_day = blocked_days.get(day) %}
          <div class="col-4 col-sm-3 col-md-2">
            <div class="border rounded p-1 text-center" style="min-height: 60px; font-size: 0.75rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              <div class="fw-bold">{{ day.day }}
              {% set day_data = productivity_data.get(day, {}) %}
              {% if day_data.get("teile", 0) > 0 %}
              <br><small class="productivity-info" 
                       title="Berechnung f√ºr {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivit√§t: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} √ó {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                       style="color: #dc2626; font-weight: bold; cursor: help; font-size: 0.6rem;">
                ({{ day_data.get("teile", 0)|int }})
              </small>
              {% endif %}
              </div>
              <div class="text-muted" style="font-size: 0.6rem;">{{ ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][day.weekday()] }}</div>
              {% if blocked_day %}
                <div class="badge mt-1" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  üö´
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge mt-1 position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge mt-1 position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark mt-1 position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success mt-1 position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><span style="font-size: 0.5rem; color: #000 !important;">{{ shift.shift_type[:3] }}</span>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.4rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Teilzeit Mitarbeiter -->
    {% if teilzeit_employees %}
    <div class="alert alert-success text-center mb-3" style="background-color: #10b981; color: white; border: none;">
      <h5 class="mb-0">‚è∞ TEILZEIT MITARBEITER ({{ teilzeit_employees|length }})</h5>
    </div>
    {% for emp in teilzeit_employees %}
    <div class="card mb-3" style="border-left: 4px solid #10b981;">
      <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #10b981;">
        <h6 class="mb-0">
          <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-white text-decoration-none">{{ emp.name }}</a>
        </h6>
        <span class="badge bg-light text-dark">{{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}h</span>
      </div>
      <div class="card-body p-2">
        <div class="row g-1">
          {% for day in month_days %}
          {% set leave = leaves.get((emp.id, day)) %}
          {% set shift = shifts.get((emp.id, day)) %}
          {% set blocked_day = blocked_days.get(day) %}
          <div class="col-{{ 12 // 7 if month_days|length <= 7 else 12 // 8 if month_days|length <= 8 else 12 // 9 if month_days|length <= 9 else 12 // 10 if month_days|length <= 10 else 12 // 11 if month_days|length <= 11 else 1 }}">
            <div class="border rounded p-1 text-center" style="min-height: 60px; font-size: 0.75rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              <div class="fw-bold">{{ day.day }}
              {% set day_data = productivity_data.get(day, {}) %}
              {% if day_data.get("teile", 0) > 0 %}
              <br><small class="productivity-info" 
                       title="Berechnung f√ºr {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivit√§t: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} √ó {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                       style="color: #dc2626; font-weight: bold; cursor: help; font-size: 0.6rem;">
                ({{ day_data.get("teile", 0)|int }})
              </small>
              {% endif %}
              </div>
              {% if blocked_day %}
                <div class="badge mt-1" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  {{ blocked_day.name[:3] }}
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge mt-1 position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge mt-1 position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark mt-1 position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success mt-1 position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><span style="font-size: 0.5rem; color: #000 !important;">{{ shift.shift_type[:3] }}</span>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.4rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Aushilfe Mitarbeiter -->
    {% if aushilfe_employees %}
    <div class="alert alert-warning text-center mb-3" style="background-color: #f59e0b; color: white; border: none;">
      <h5 class="mb-0">ü§ù AUSHILFE MITARBEITER ({{ aushilfe_employees|length }})</h5>
    </div>
    {% for emp in aushilfe_employees %}
    <div class="card mb-3" style="border-left: 4px solid #f59e0b;">
      <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #f59e0b;">
        <h6 class="mb-0">
          <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="text-white text-decoration-none">{{ emp.name }}</a>
        </h6>
        <span class="badge bg-light text-dark">{{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}h</span>
      </div>
      <div class="card-body p-2">
        <div class="row g-1">
          {% for day in month_days %}
          {% set leave = leaves.get((emp.id, day)) %}
          {% set shift = shifts.get((emp.id, day)) %}
          {% set blocked_day = blocked_days.get(day) %}
          <div class="col-4 col-sm-3 col-md-2">
            <div class="border rounded p-1 text-center" style="min-height: 60px; font-size: 0.75rem; {% if blocked_day %}background-color: #fee2e2;{% endif %}">
              <div class="fw-bold">{{ day.day }}
              {% set day_data = productivity_data.get(day, {}) %}
              {% if day_data.get("teile", 0) > 0 %}
              <br><small class="productivity-info" 
                       title="Berechnung f√ºr {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivit√§t: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} √ó {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                       style="color: #dc2626; font-weight: bold; cursor: help; font-size: 0.6rem;">
                ({{ day_data.get("teile", 0)|int }})
              </small>
              {% endif %}
              </div>
              <div class="text-muted" style="font-size: 0.6rem;">{{ ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][day.weekday()] }}</div>
              {% if blocked_day %}
                <div class="badge mt-1" style="background-color: #dc2626; color: white; font-size: 0.6rem;" 
                     title="{{ blocked_day.name }}{% if blocked_day.description %} - {{ blocked_day.description }}{% endif %}">
                  üö´
                </div>
              {% elif leave %}
                {% if leave.leave_type == 'Urlaub' %}
                  <div class="badge mt-1 position-relative" style="background-color: orange; color: green;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% elif leave.leave_type == 'Krank' %}
                  <div class="badge mt-1 position-relative" style="background-color: red; color: white;">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% else %}
                  <div class="badge bg-warning text-dark mt-1 position-relative">
                    {{ leave.leave_type[:2] }}
                    <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                            onclick="deleteLeave({{ leave.id }})" style="font-size: 0.4rem;"></button>
                  </div>
                {% endif %}
              {% elif shift %}
                <div class="badge bg-success mt-1 position-relative" style="color: #000 !important;">
                  {% if shift.approved %}{{ shift.hours }}h{% else %}"{{ shift.hours }}h"{% endif %}
                  {% if shift.shift_type and not shift.shift_type.startswith('Standard') %}<br><span style="font-size: 0.5rem; color: #000 !important;">{{ shift.shift_type[:3] }}</span>{% endif %}
                  {% if True %}
                  <button type="button" class="btn-close btn-close-sm position-absolute top-0 start-100 translate-middle" 
                          onclick="deleteShift({{ shift.id }})" style="font-size: 0.4rem;"></button>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <!-- Button to open Add Shift modal -->
  <button type="button" class="btn btn-success btn-lg mt-3" onclick="openAddShiftModal()">
    ‚ûï Einsatz hinzuf√ºgen
  </button>

  <!-- Add Shift Modal -->
  <div id="addShiftModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Einsatz hinzuf√ºgen</h3>
        <button type="button" class="modal-close" onclick="closeAddShiftModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('add_shift') }}" class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="employee_id">Mitarbeiter*</label>
            <select class="form-select" id="employee_id" name="employee_id" required>
              <option value="">Mitarbeiter ausw√§hlen</option>
              {% if session.get('is_admin') %}
                {% for emp in employees %}
                <option value="{{ emp.id }}">{{ emp.name }}</option>
                {% endfor %}
              {% else %}
                {% for emp in employees %}
                  {% if emp.id == session.get('user_id') %}
                  <option value="{{ emp.id }}">{{ emp.name }}</option>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="date">Datum*</label>
            <input type="date" class="form-control" id="date" name="date" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="hours">Stunden*</label>
            <input type="number" step="0.5" class="form-control" id="hours" name="hours" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="shift_type">Schichttyp (optional)</label>
            <input type="text" class="form-control" id="shift_type" name="shift_type" placeholder="z.B. Fr√ºh, Sp√§t" />
          </div>
          <div class="col-12 d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary" onclick="closeAddShiftModal()">Abbrechen</button>
            <button type="submit" class="btn btn-success">Hinzuf√ºgen</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function deleteShift(shiftId) {
  if (confirm('Einsatz wirklich l√∂schen?')) {
    window.location.href = '/einsatz/loeschen/' + shiftId;
  }
}

function deleteLeave(leaveId) {
  if (confirm('Abwesenheit wirklich l√∂schen?')) {
    window.location.href = '/abwesenheit/loeschen/' + leaveId;
  }
}

// Modal functionality
function openAddShiftModal() {
  document.getElementById('addShiftModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeAddShiftModal() {
  document.getElementById('addShiftModal').classList.remove('show');
  document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('addShiftModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAddShiftModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeAddShiftModal();
  }
});
</script>

{% endblock %}

