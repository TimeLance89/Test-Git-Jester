{% extends "layout.html" %}
{% block title %}Mitarbeiter verwalten - Dienstplaner{% endblock %}
{% block content %}
{% set month_names = [
  "Januar", "Februar", "März", "April", "Mai", "Juni",
  "Juli", "August", "September", "Oktober", "November", "Dezember"
] %}
{% set month_label = month_names[current_month - 1] if 1 <= current_month <= 12 else current_month %}
{% set fulltime_count = employees|selectattr('position', 'equalto', 'Vollzeit')|list|length %}
{% set parttime_count = employees|selectattr('position', 'equalto', 'Teilzeit')|list|length %}
{% set temp_count = employees|selectattr('position', 'equalto', 'Aushilfe')|list|length %}

<div class="employees-page">
  <section class="employees-hero">
    <div class="employees-hero-main">
      <div class="hero-top">
        <div class="hero-icon-bubble" aria-hidden="true">👥</div>
        <div>
          <p class="hero-eyebrow">Teamverwaltung</p>
          <h1>Mitarbeiterverwaltung</h1>
        </div>
      </div>
      <p class="hero-description">
        Behalte alle Teammitglieder, ihre Verfügbarkeiten und offenen Kapazitäten im Blick. Plane smarter mit aktuellen Kennzahlen
        und schnellen Aktionen.
      </p>
      <div class="hero-actions">
        <button type="button" class="btn btn-primary btn-hero" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
          <span class="btn-hero-icon" aria-hidden="true">➕</span>
          Neuen Mitarbeiter anlegen
        </button>
        <a class="btn btn-outline-secondary btn-hero" href="{{ url_for('monthly_report') }}">
          <span class="btn-hero-icon" aria-hidden="true">📈</span>
          Zum Monatsbericht
        </a>
      </div>
    </div>
    <div class="employees-hero-meta">
      <div class="hero-stat">
        <p class="stat-label">Gesamtteam</p>
        <p class="stat-value">{{ employees|length }}</p>
        <p class="stat-support">{{ fulltime_count }} Vollzeit · {{ parttime_count }} Teilzeit · {{ temp_count }} Aushilfen</p>
      </div>
      <div class="hero-stat">
        <p class="stat-label">Berichtszeitraum</p>
        <p class="stat-value">{{ month_label }} {{ current_year }}</p>
        <p class="stat-support">Stunden & Kapazitäten basieren auf diesem Zeitraum</p>
      </div>
      <div class="hero-highlight">
        <div class="highlight-icon" aria-hidden="true">💡</div>
        <div>
          <p class="highlight-title">Planung optimieren</p>
          <p class="highlight-text">Nutze die Insights zu Überstunden und freien Kontingenten, um Schichten besser zu verteilen.</p>
        </div>
      </div>
    </div>
  </section>

  {% if planning_insights %}
  <section class="planning-insights">
    <article class="insight-card insight-card-primary">
      <header class="insight-header">
        <span class="insight-icon" aria-hidden="true">📊</span>
        <div>
          <h2>Aushilfen-Übersicht</h2>
          <p>Gesamtbild aller stundenbasierten Teammitglieder</p>
        </div>
      </header>
      <div class="insight-metrics">
        <div class="insight-metric">
          <span class="metric-label">Verfügbare Stunden</span>
          <span class="metric-value">{{ planning_insights.total_remaining_hours|round(1) }}h</span>
        </div>
        <div class="insight-metric">
          <span class="metric-label">Überstunden</span>
          <span class="metric-value">{{ planning_insights.total_overtime_hours|round(1) }}h</span>
        </div>
      </div>
    </article>

    {% if planning_insights.overutilized %}
    <article class="insight-card insight-card-warning">
      <header class="insight-header">
        <span class="insight-icon" aria-hidden="true">⚠️</span>
        <div>
          <h2>Überstunden-Alarm</h2>
          <p>{{ planning_insights.overutilized|length }} Aushilfen mit kritischen Überstunden</p>
        </div>
      </header>
      <ul class="insight-list">
        {% for emp in planning_insights.overutilized[:4] %}
        <li>
          <div>
            <p class="insight-list-title">{{ emp.employee_name }}</p>
            <p class="insight-list-meta">{{ emp.department }}</p>
          </div>
          <span class="insight-badge negative">+{{ emp.overtime_hours }}h</span>
        </li>
        {% endfor %}
      </ul>
      {% if planning_insights.overutilized|length > 4 %}
      <p class="insight-footer">... und {{ planning_insights.overutilized|length - 4 }} weitere</p>
      {% endif %}
    </article>
    {% endif %}

    {% if planning_insights.underutilized %}
    <article class="insight-card insight-card-positive">
      <header class="insight-header">
        <span class="insight-icon" aria-hidden="true">🧭</span>
        <div>
          <h2>Freie Kapazitäten</h2>
          <p>{{ planning_insights.underutilized|length }} Aushilfen mit verfügbaren Stunden</p>
        </div>
      </header>
      <ul class="insight-list">
        {% for emp in planning_insights.underutilized[:4] %}
        <li>
          <div>
            <p class="insight-list-title">{{ emp.employee_name }}</p>
            <p class="insight-list-meta">{{ emp.department }}</p>
          </div>
          <span class="insight-badge positive">{{ emp.remaining_hours }}h frei</span>
        </li>
        {% endfor %}
      </ul>
      {% if planning_insights.underutilized|length > 4 %}
      <p class="insight-footer">... und {{ planning_insights.underutilized|length - 4 }} weitere</p>
      {% endif %}
    </article>
    {% endif %}
  </section>
  {% endif %}

  <section class="employees-section">
    <div class="section-header">
      <div>
        <p class="section-eyebrow">Teamübersicht</p>
        <h2>Alle Mitarbeiter ({{ employees|length }})</h2>
      </div>
      <form method="get" class="toolbar-form">
        <div class="toolbar-field">
          <label for="month">Monat</label>
          <select name="month" id="month" class="form-select form-select-sm">
            {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="toolbar-field">
          <label for="year">Jahr</label>
          <select name="year" id="year" class="form-select form-select-sm">
            {% for y in range(2020, 2030) %}
            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Aktualisieren</button>
      </form>
    </div>

    {% if employees %}
    <div class="employees-card-grid">
      {% for emp in employees %}
      {% set emp_hours = hours_summary.get(emp.id, {}) %}
      {% set worked = emp_hours.get('worked_hours', 0) %}
      {% set remaining = emp_hours.get('remaining_hours', 0) %}
      {% set overtime = emp_hours.get('overtime_hours', 0) %}
      {% set percentage = emp_hours.get('completion_percentage', 0) %}
      {% set avatar_text = emp.name[:1]|upper if emp.name else '👤' %}
      <article class="employee-card">
        <header class="employee-card-header">
          <div class="employee-identity">
            <div class="employee-avatar" aria-hidden="true">{{ avatar_text }}</div>
            <div>
              <h3>{{ emp.name }}</h3>
              <div class="employee-card-tags">
                {% if emp.short_code %}
                <span class="badge-chip neutral">{{ emp.short_code }}</span>
                {% endif %}
                {% if emp.position %}
                <span class="badge-chip {{ 'fulltime' if emp.position == 'Vollzeit' else 'parttime' if emp.position == 'Teilzeit' else 'temporary' if emp.position == 'Aushilfe' else 'neutral' }}">{{ emp.position }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="employee-card-actions">
            <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="employee-action">
              <span aria-hidden="true">👁️</span> Profil
            </a>
            <a href="{{ url_for('delete_employee', emp_id=emp.id) }}"
               class="employee-action danger"
               onclick="return confirm('Mitarbeiter {{ emp.name }} wirklich löschen?')">
              <span aria-hidden="true">🗑️</span>
            </a>
          </div>
        </header>

        <div class="employee-meta">
          <div>
            <span class="meta-label">Abteilung</span>
            <span class="meta-value">{% if emp.department %}{{ emp.department.name }}{% else %}<em>Keine Abteilung</em>{% endif %}</span>
          </div>
          <div>
            <span class="meta-label">Sollstunden</span>
            <span class="meta-value">
              {% if emp.monthly_hours and emp.monthly_hours >= 160 %}
                Vollzeit
              {% elif emp.monthly_hours %}
                {{ emp.monthly_hours }}h / Monat
              {% else %}
                <em>Nicht festgelegt</em>
              {% endif %}
            </span>
          </div>
          {% if emp.employee_number %}
          <div>
            <span class="meta-label">Personalnummer</span>
            <span class="meta-value">{{ emp.employee_number }}</span>
          </div>
          {% endif %}
        </div>

        <div class="employee-metrics">
          <div class="metric">
            <span class="metric-label">Geleistete Stunden</span>
            <span class="metric-value positive">{{ worked }}h</span>
            {% if emp_hours.get('shift_count', 0) > 0 %}
            <span class="metric-support">{{ emp_hours.get('shift_count', 0) }} Einsätze</span>
            {% endif %}
          </div>
          {% if emp.position != 'Vollzeit' %}
          <div class="metric">
            <span class="metric-label">Reststunden</span>
            <span class="metric-value {{ 'negative' if remaining > 20 else 'warning' if remaining > 0 else 'muted' }}">{{ remaining if emp.monthly_hours and emp.monthly_hours < 160 else '–' }}{% if emp.monthly_hours and emp.monthly_hours < 160 %}h{% endif %}</span>
            {% if remaining > 20 and emp.monthly_hours and emp.monthly_hours < 160 %}
            <span class="metric-support negative">Hohe Verfügbarkeit</span>
            {% elif remaining > 0 and emp.monthly_hours and emp.monthly_hours < 160 %}
            <span class="metric-support warning">Noch Kapazität frei</span>
            {% endif %}
          </div>
          <div class="metric">
            <span class="metric-label">Überstunden</span>
            <span class="metric-value {{ 'negative' if overtime > 10 else 'warning' if overtime > 0 else 'muted' }}">{% if overtime > 0 %}+{{ overtime }}h{% else %}0h{% endif %}</span>
            {% if overtime > 10 %}
            <span class="metric-support negative">Kritischer Bereich</span>
            {% elif overtime > 0 %}
            <span class="metric-support warning">Leichte Überstunden</span>
            {% endif %}
          </div>
          {% endif %}
        </div>

        {% if emp.monthly_hours and emp.monthly_hours < 160 %}
        <div class="employee-progress">
          <div class="progress-meta">
            <span>Fortschritt</span>
            <span>{{ "%.0f"|format(percentage) }}%</span>
          </div>
          <div class="progress-track">
            <div class="progress-bar {{ 'negative' if percentage >= 100 else 'positive' if percentage >= 80 else 'warning' }}"
                 style="width: {{ 100 if percentage > 100 else percentage }}%"></div>
          </div>
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-icon" aria-hidden="true">👥</div>
      <p class="empty-title">Noch keine Mitarbeiter angelegt</p>
      <p class="empty-text">Starte mit einem Klick auf „Neuen Mitarbeiter anlegen“ und fülle dein Team.</p>
    </div>
    {% endif %}
  </section>
</div>

<!-- Modal: Mitarbeiter hinzufügen -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEmployeeModalLabel"><span aria-hidden="true">➕</span> Neuen Mitarbeiter anlegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('add_employee') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="name" class="form-label">Name*</label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="col-md-6">
              <label for="short_code" class="form-label">Kürzel</label>
              <input type="text" class="form-control" id="short_code" name="short_code" maxlength="20" placeholder="z.B. JD">
            </div>
            <div class="col-md-6">
              <label for="employee_number" class="form-label">Personalnummer</label>
              <input type="text" class="form-control" id="employee_number" name="employee_number">
            </div>
            <div class="col-md-6">
              <label for="department_id" class="form-label">Abteilung*</label>
              <select class="form-select" id="department_id" name="department_id" required>
                <option value="">Abteilung wählen</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="position" class="form-label">Position*</label>
              <select class="form-select" id="position" name="position" required>
                <option value="">Position wählen</option>
                <option value="Vollzeit">Vollzeit</option>
                <option value="Teilzeit">Teilzeit</option>
                <option value="Aushilfe">Aushilfe</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="monthly_hours" class="form-label">Monatliche Stunden</label>
              <input type="number" step="0.5" class="form-control" id="monthly_hours" name="monthly_hours" placeholder="z.B. 160">
              <small class="form-text text-muted">Vollzeit: ≥160h, Teilzeit/Aushilfe: individuell</small>
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">E-Mail</label>
              <input type="email" class="form-control" id="email" name="email">
            </div>
            <div class="col-md-6">
              <label for="phone" class="form-label">Telefon</label>
              <input type="tel" class="form-control" id="phone" name="phone">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Mitarbeiter anlegen</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
