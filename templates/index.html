{% extends "layout.html" %}
{% block title %}Dashboard - Einsatzplaner{% endblock %}
{% block content %}
{% set is_admin = session.get('is_admin') %}
{% set is_system_admin = is_admin and (current_user and not current_user.department_id) %}
{% set team_size = employee_count or 0 %}
<div class="dashboard-page">
  <section class="dashboard-hero">
    <div class="dashboard-hero-main">
      <p class="hero-eyebrow">
        {% if is_system_admin %}
          Systemadministration
        {% elif is_admin %}
          Teamleitung &amp; Planung
        {% else %}
          Mitarbeiterbereich
        {% endif %}
      </p>
      <h1>Hallo {{ current_user.name if current_user else 'Team' }} 👋</h1>
      <p class="hero-subtitle">
        {% if is_admin %}
          Der aktuelle Überblick über echte Einsätze, Abwesenheiten und Kapazitäten für die nächsten sieben Tage.
        {% else %}
          Behalte deine Schichten, Teamabwesenheiten und Freigaben live im Blick.
        {% endif %}
      </p>
      {% if is_admin %}
      <div class="hero-metrics" role="list">
        <div class="hero-metric" role="listitem">
          <span class="hero-metric-label">Geplante Stunden (7 Tage)</span>
          <span class="hero-metric-value" data-count-to="{{ total_hours }}">0</span>
        </div>
        <div class="hero-metric" role="listitem">
          <span class="hero-metric-label">Eingesetzte Personen</span>
          <span class="hero-metric-value" data-count-to="{{ unique_employees }}">0</span>
        </div>
        <div class="hero-metric" role="listitem">
          <span class="hero-metric-label">Ø Abdeckung</span>
          <span class="hero-metric-value" data-count-to="{{ coverage_average }}">0</span><span class="hero-metric-suffix">%</span>
        </div>
      </div>
      {% else %}
      <div class="hero-compact" role="list">
        <article class="hero-compact-card" role="listitem">
          <p class="hero-compact-label">Nächster Einsatz</p>
          {% if next_shift_info %}
          <p class="hero-compact-value">{{ next_shift_info.date_label }}</p>
          <p class="hero-compact-helper">{{ next_shift_info.title }}{% if next_shift_info.hours %} • {{ next_shift_info.hours }} Std{% endif %}</p>
          {% else %}
          <p class="hero-compact-value">Noch offen</p>
          <p class="hero-compact-helper">Aktuell ist keine Schicht geplant.</p>
          {% endif %}
        </article>
        <article class="hero-compact-card" role="listitem">
          <p class="hero-compact-label">Geplante Woche</p>
          <p class="hero-compact-value">{{ personal_week_overview.shift_count }} Schichten</p>
          <p class="hero-compact-helper">{{ personal_week_overview.hours }} Std • {{ personal_week_overview.leave_days }} freie Tage</p>
        </article>
        <article class="hero-compact-card" role="listitem">
          <p class="hero-compact-label">Offene Anträge</p>
          <p class="hero-compact-value">{{ personal_week_overview.pending_leaves }}</p>
          <p class="hero-compact-helper">Noch ausstehende Abwesenheiten.</p>
        </article>
      </div>
      {% endif %}
      <div class="dashboard-hero-actions">
        <a class="hero-action primary" href="{{ url_for('schedule') }}">
          <span class="hero-action-icon">📅</span>
          Dienstplan öffnen
        </a>
        {% if is_admin %}
          <a class="hero-action" href="{{ url_for('leave_requests') }}">
            <span class="hero-action-icon">📝</span>
            Anträge prüfen
          </a>
          <a class="hero-action" href="{{ url_for('employees') }}">
            <span class="hero-action-icon">👥</span>
            Team verwalten
          </a>
        {% else %}
          <a class="hero-action" href="{{ url_for('leave_form') }}">
            <span class="hero-action-icon">📝</span>
            Urlaub beantragen
          </a>
          <a class="hero-action" href="{{ url_for('employee_hours_overview') }}">
            <span class="hero-action-icon">⏱️</span>
            Meine Stunden
          </a>
        {% endif %}
      </div>
    </div>
    <div class="dashboard-hero-aside">
      <div class="hero-highlight">
        <div class="highlight-icon">⚡</div>
        <div>
          {% if next_shift_info %}
            <p class="highlight-title">{{ 'Mein nächster Einsatz' if next_shift_info.is_personal else 'Nächster Einsatz' }}</p>
            <p class="highlight-text">
              {{ next_shift_info.title }} • {{ next_shift_info.hours }} Std am {{ next_shift_info.date_label }}
              {% if is_admin and next_shift_info.employee %}– {{ next_shift_info.employee }}{% endif %}
              {% if next_shift_info.department %}<br />{{ next_shift_info.department }}{% endif %}
            </p>
          {% elif next_pending_leave %}
            <p class="highlight-title">Offener Abwesenheitsantrag</p>
            <p class="highlight-text">
              {{ next_pending_leave.type }} von {{ next_pending_leave.employee or 'Unbekannt' }}<br />
              Zeitraum: {{ next_pending_leave.date_range }}
            </p>
          {% else %}
            <p class="highlight-title">Aktueller Hinweis</p>
            <p class="highlight-text">Keine offenen Anträge oder geplanten Einsätze im Zeitraum {{ week_window_label }}.</p>
          {% endif %}
        </div>
      </div>
      {% if current_user and current_user.department %}
      <div class="hero-meta-card">
        <p class="meta-label">Meine Abteilung</p>
        <p class="meta-value">{{ current_user.department.name }}</p>
        {% if current_user.department.area %}
        <p class="meta-support">Bereich: {{ current_user.department.area }}</p>
        {% endif %}
      </div>
      {% elif is_system_admin %}
      <div class="hero-meta-card">
        <p class="meta-label">Organisation</p>
        <p class="meta-value">Alle Standorte</p>
        <p class="meta-support">Globale Systemübersicht aktiv</p>
      </div>
      {% endif %}
      <div class="hero-meta-card">
        <p class="meta-label">Auswertungszeitraum</p>
        <p class="meta-value">{{ week_window_label }}</p>
        <p class="meta-support">Alle Kennzahlen basieren auf genehmigten Einsätzen und Abwesenheiten.</p>
      </div>
    </div>
  </section>

  {% if is_admin %}
  <section class="dashboard-kpis" aria-label="Kennzahlen">
    <article class="kpi-card kpi-employees">
      <div class="kpi-icon">👥</div>
      <div class="kpi-content">
        <p class="kpi-label">Aktive Mitarbeitende</p>
        <p class="kpi-value">{{ employee_count }}</p>
        <p class="kpi-helper">Teamgröße im aktuellen Verantwortungsbereich</p>
      </div>
      <a class="kpi-link" href="{{ url_for('employees') }}">Team organisieren →</a>
    </article>

    <article class="kpi-card kpi-departments">
      <div class="kpi-icon">🏢</div>
      <div class="kpi-content">
        <p class="kpi-label">Abteilungen sichtbar</p>
        <p class="kpi-value">{{ department_count }}</p>
        <p class="kpi-helper">Struktur der Organisation im Blick behalten</p>
      </div>
      <a class="kpi-link" href="{{ url_for('departments') }}">Bereiche verwalten →</a>
    </article>

    <article class="kpi-card kpi-leaves">
      <div class="kpi-icon">📋</div>
      <div class="kpi-content">
        <p class="kpi-label">Offene Abwesenheiten</p>
        <p class="kpi-value">{{ pending_leaves }}</p>
        <p class="kpi-helper">Anträge warten auf Rückmeldung im betrachteten Zeitraum</p>
      </div>
      <a class="kpi-link" href="{{ url_for('leave_requests') }}">Anträge bearbeiten →</a>
    </article>

    <article class="kpi-card kpi-coverage">
      <div class="kpi-icon">📊</div>
      <div class="kpi-content">
        <p class="kpi-label">Ø Abdeckung (7 Tage)</p>
        <p class="kpi-value">{{ coverage_average }}%</p>
        <p class="kpi-helper">{{ coverage_message }}</p>
      </div>
    </article>
  </section>
  {% else %}
  <section class="dashboard-essentials" aria-label="Mein Überblick">
    <article class="essentials-card">
      <header class="essentials-header">
        <h2 class="essentials-title">Meine Woche</h2>
        <p class="essentials-subtitle">Alles Wichtige auf einen Blick.</p>
      </header>
      <ul class="essentials-list">
        <li class="essentials-item">
          <div class="essentials-meta">
            <p class="essentials-label">Bestätigte Stunden</p>
            <p class="essentials-hint">Nächste sieben Tage</p>
          </div>
          <span class="essentials-value">{{ personal_week_overview.hours }}</span>
        </li>
        <li class="essentials-item">
          <div class="essentials-meta">
            <p class="essentials-label">Geplante Schichten</p>
            <p class="essentials-hint">Genehmigte Einsätze</p>
          </div>
          <span class="essentials-value">{{ personal_week_overview.shift_count }}</span>
        </li>
        <li class="essentials-item">
          <div class="essentials-meta">
            <p class="essentials-label">Abwesenheitstage</p>
            <p class="essentials-hint">Im selben Zeitraum</p>
          </div>
          <span class="essentials-value">{{ personal_week_overview.leave_days }}</span>
        </li>
      </ul>
    </article>
    <article class="essentials-card">
      <header class="essentials-header">
        <h2 class="essentials-title">Status &amp; Anträge</h2>
        <p class="essentials-subtitle">So steht dein Team diese Woche da.</p>
      </header>
      <div class="essentials-highlight">
        <p class="essentials-label">Nächster Einsatz</p>
        {% if next_shift_info %}
        <p class="essentials-lead">{{ next_shift_info.title }}</p>
        <p class="essentials-hint">{{ next_shift_info.date_label }}{% if next_shift_info.hours %} • {{ next_shift_info.hours }} Std{% endif %}{% if next_shift_info.department %} • {{ next_shift_info.department }}{% endif %}</p>
        {% else %}
        <p class="essentials-empty">Noch keine Schicht geplant.</p>
        {% endif %}
      </div>
      <ul class="essentials-list">
        <li class="essentials-item">
          <div class="essentials-meta">
            <p class="essentials-label">Offene Anträge</p>
            <p class="essentials-hint">Persönlich</p>
          </div>
          <span class="essentials-value">{{ personal_week_overview.pending_leaves }}</span>
        </li>
        <li class="essentials-item">
          <div class="essentials-meta">
            <p class="essentials-label">Team im Urlaub</p>
            <p class="essentials-hint">Genehmigt &amp; offen (7 Tage)</p>
          </div>
          <span class="essentials-value">{{ leave_status_overview.approved + leave_status_overview.pending }}</span>
        </li>
      </ul>
    </article>
  </section>
  {% endif %}

  <section class="dashboard-analytics" aria-label="Datenvisualisierung">
    <div class="analytics-grid">
      {% if is_admin %}
      <article class="analytics-card chart-card wide">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Teamkapazität</p>
            <h2>Geplante Stunden &amp; Besetzung</h2>
          </div>
          <p class="analytics-helper">Zeitraum {{ week_window_label }}</p>
        </header>
        <canvas id="weekHoursChart" role="img" aria-label="Geplante Stunden und eingesetzte Personen"></canvas>
        <ul class="chart-legend" aria-hidden="true">
          <li><span class="legend-dot is-hours"></span><span>Stunden gesamt</span></li>
          <li><span class="legend-dot is-people"></span><span>Eingesetzte Personen</span></li>
          <li><span class="legend-dot is-leave"></span><span>Team in Abwesenheit</span></li>
        </ul>
      </article>

      <article class="analytics-card activity-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Timeline</p>
            <h2>Nächste Ereignisse</h2>
          </div>
        </header>
        <ul class="activity-list">
          {% if upcoming_events %}
            {% for event in upcoming_events %}
            <li class="activity-item activity-{{ event.type }}">
              <div class="activity-meta">
                <span class="activity-date">{{ event.date_label }}</span>
                <span class="activity-type">{% if event.type == 'shift' %}Einsatz{% else %}Abwesenheit{% endif %}</span>
              </div>
              <p class="activity-title">
                {% if event.type == 'shift' %}
                  {{ event.employee }} – {{ event.title }}
                {% else %}
                  {{ event.employee }} – {{ event.title }}
                {% endif %}
              </p>
              <p class="activity-subtitle">
                {% if event.type == 'shift' %}
                  {{ event.hours }} Std{% if event.department %} • {{ event.department }}{% endif %}
                {% else %}
                  {{ event.start }} – {{ event.end }} • {{ 'Genehmigt' if event.approved else 'Offen' }}{% if event.department %} • {{ event.department }}{% endif %}
                {% endif %}
              </p>
            </li>
            {% endfor %}
          {% else %}
            <li class="activity-empty">Keine Ereignisse im Zeitraum {{ week_window_label }}.</li>
          {% endif %}
        </ul>
      </article>

      <article class="analytics-card chart-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Abwesenheiten</p>
            <h2>Statusübersicht</h2>
          </div>
        </header>
        <div class="chart-wrapper">
          <canvas id="leaveStatusChart" role="img" aria-label="Status genehmigt vs. offen"></canvas>
          {% if leave_status_overview.approved == 0 and leave_status_overview.pending == 0 %}
          <p class="chart-empty">Keine Abwesenheiten im ausgewählten Zeitraum.</p>
          {% endif %}
        </div>
        <ul class="chart-stats">
          <li>Genehmigt: {{ leave_status_overview.approved }}</li>
          <li>Offen: {{ leave_status_overview.pending }}</li>
          {% if approval_rate is not none %}
          <li>Freigaberate (30 Tage): {{ approval_rate }}%</li>
          {% endif %}
        </ul>
      </article>

      <article class="analytics-card chart-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Teamstruktur</p>
            <h2>Verteilung nach Abteilung</h2>
          </div>
        </header>
        <div class="chart-wrapper">
          <canvas id="departmentChart" role="img" aria-label="Mitarbeitende nach Abteilung"></canvas>
          {% if department_distribution | sum(attribute='count') == 0 %}
          <p class="chart-empty">Keine Mitarbeitenden zugeordnet.</p>
          {% endif %}
        </div>
        <ul class="chart-stats">
          {% if department_distribution %}
            {% for entry in department_distribution %}
            <li>{{ entry.name }}: {{ entry.count }}</li>
            {% endfor %}
          {% else %}
            <li>Keine Abteilungsdaten verfügbar.</li>
          {% endif %}
        </ul>
      </article>
      {% else %}
      {% set personal_events = upcoming_events[:4] if upcoming_events else [] %}
      <article class="analytics-card activity-card wide compact-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Meine Timeline</p>
            <h2>Nächste Ereignisse</h2>
          </div>
        </header>
        <ul class="activity-list">
          {% if personal_events %}
            {% for event in personal_events %}
            <li class="activity-item activity-{{ event.type }}">
              <div class="activity-meta">
                <span class="activity-date">{{ event.date_label }}</span>
                <span class="activity-type">{% if event.type == 'shift' %}Einsatz{% else %}Abwesenheit{% endif %}</span>
              </div>
              <p class="activity-title">{{ event.title }}</p>
              <p class="activity-subtitle">
                {% if event.type == 'shift' %}
                  {{ event.hours }} Std{% if event.department %} • {{ event.department }}{% endif %}
                {% else %}
                  {{ event.start }} – {{ event.end }} • {{ 'Genehmigt' if event.approved else 'Offen' }}
                {% endif %}
              </p>
            </li>
            {% endfor %}
          {% else %}
            <li class="activity-empty">Keine persönlichen Ereignisse im Zeitraum {{ week_window_label }}.</li>
          {% endif %}
        </ul>
      </article>

      {% set week_preview = personal_day_overview[:5] if personal_day_overview else [] %}
      <article class="analytics-card personal-week-card compact-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Wochenplanung</p>
            <h2>Meine Einsätze</h2>
          </div>
        </header>
        <ul class="activity-list">
          {% if week_preview %}
            {% for entry in week_preview %}
            <li class="activity-item activity-{{ entry.status }}">
              <div class="activity-meta">
                <span class="activity-date">{{ entry.date_label }}</span>
                <span class="activity-type">
                  {% if entry.status == 'shift' %}Einsatz{% elif entry.status == 'leave' %}Abwesend{% else %}Frei{% endif %}
                </span>
              </div>
              <p class="activity-title">{{ entry.description }}</p>
            </li>
            {% endfor %}
          {% else %}
            <li class="activity-empty">Für die kommende Woche sind noch keine Einsätze geplant.</li>
          {% endif %}
        </ul>
      </article>

      <article class="analytics-card summary-card">
        <header class="analytics-header">
          <div>
            <p class="analytics-eyebrow">Status</p>
            <h2>Abwesenheiten im Überblick</h2>
          </div>
        </header>
        <div class="summary-grid">
          <div>
            <p class="summary-label">Genehmigt</p>
            <p class="summary-value">{{ leave_status_overview.approved }}</p>
          </div>
          <div>
            <p class="summary-label">Offen</p>
            <p class="summary-value">{{ leave_status_overview.pending }}</p>
          </div>
          <div>
            <p class="summary-label">Geplante Tage</p>
            <p class="summary-value">{{ personal_week_overview.leave_days }}</p>
          </div>
        </div>
        <a class="summary-link" href="{{ url_for('leave_form') }}">Zu meinen Anträgen →</a>
      </article>
      {% endif %}
    </div>
  </section>

  <section class="dashboard-panels">
    <article class="dashboard-panel">
      <header class="panel-header">
        <div>
          <p class="panel-eyebrow">Aktuelles</p>
          <h2>Prioritäten heute</h2>
        </div>
      </header>
      <ul class="panel-list">
        {% if is_admin %}
        <li>
          <span class="status-dot {% if pending_leaves > 0 %}status-warning{% else %}status-success{% endif %}"></span>
          <div>
            <p class="list-title">Offene Abwesenheiten</p>
            <p class="list-subtitle">{{ pending_leaves }} Anträge warten auf Freigabe.</p>
          </div>
          <a class="panel-link" href="{{ url_for('leave_requests') }}">Bearbeiten</a>
        </li>
        <li>
          <span class="status-dot status-info"></span>
          <div>
            <p class="list-title">Geplante Stunden</p>
            <p class="list-subtitle">{{ total_hours }} Stunden in den nächsten sieben Tagen.</p>
          </div>
          <a class="panel-link" href="{{ url_for('schedule') }}">Öffnen</a>
        </li>
        <li>
          <span class="status-dot status-neutral"></span>
          <div>
            <p class="list-title">Eigene Woche</p>
            <p class="list-subtitle">
              {% if personal_week_overview.shift_count > 0 %}
                {{ personal_week_overview.shift_count }} Schichten • {{ personal_week_overview.hours }} Std • {{ personal_week_overview.leave_days }} Tage Abwesenheit
              {% else %}
                Keine genehmigten Einsätze für dich in den nächsten sieben Tagen.
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('schedule') }}">Teamstunden</a>
        </li>
        {% else %}
        <li>
          <span class="status-dot {% if personal_week_overview.pending_leaves > 0 %}status-warning{% else %}status-success{% endif %}"></span>
          <div>
            <p class="list-title">Meine Anträge</p>
            <p class="list-subtitle">
              {% if personal_week_overview.pending_leaves > 0 %}
                {{ personal_week_overview.pending_leaves }} Anfrage(n) warten auf Rückmeldung.
              {% else %}
                Alle Abwesenheiten sind freigegeben.
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('leave_form') }}">Status prüfen</a>
        </li>
        <li>
          <span class="status-dot status-info"></span>
          <div>
            <p class="list-title">Nächster Einsatz</p>
            <p class="list-subtitle">
              {% if next_shift_info %}
                {{ next_shift_info.date_label }}{% if next_shift_info.hours %} • {{ next_shift_info.hours }} Std{% endif %}
              {% else %}
                Noch kein Einsatz geplant.
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('schedule') }}">Dienstplan</a>
        </li>
        <li>
          <span class="status-dot status-neutral"></span>
          <div>
            <p class="list-title">Woche im Überblick</p>
            <p class="list-subtitle">
              {% if personal_week_overview.shift_count > 0 %}
                {{ personal_week_overview.shift_count }} Schichten • {{ personal_week_overview.hours }} Std • {{ personal_week_overview.leave_days }} Tage frei
              {% else %}
                Deine Woche ist aktuell frei von Einsätzen.
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('employee_hours_overview') }}">Meine Übersicht</a>
        </li>
        {% endif %}
      </ul>
    </article>

    {% if is_admin %}
    <article class="dashboard-panel accent">
      <header class="panel-header">
        <div>
          <p class="panel-eyebrow">Insights</p>
          <h2>Trends aus echten Daten</h2>
        </div>
      </header>
      <div class="insight-grid">
        <div class="insight-card">
          <p class="insight-label">Ø Abdeckung</p>
          <p class="insight-value">{{ coverage_average }}%</p>
          <p class="insight-text">{{ coverage_message }}</p>
        </div>
        <div class="insight-card">
          <p class="insight-label">Top-Einsätze</p>
          {% if top_contributors %}
          <ul class="insight-list">
            {% for contributor in top_contributors %}
            <li>{{ contributor.name }} • {{ contributor.hours }} Std</li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="insight-text">Keine Einsätze im Zeitraum geplant.</p>
          {% endif %}
        </div>
        <div class="insight-card">
          <p class="insight-label">Abwesenheiten nach Typ</p>
          {% if leave_type_breakdown %}
          <ul class="insight-list">
            {% for entry in leave_type_breakdown[:3] %}
            <li>{{ entry.type }}: {{ entry.count }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="insight-text">Keine Abwesenheiten gemeldet.</p>
          {% endif %}
        </div>
      </div>
    </article>
    {% else %}
    <article class="dashboard-panel accent">
      <header class="panel-header">
        <div>
          <p class="panel-eyebrow">Mein Fokus</p>
          <h2>Aktuelle Hinweise</h2>
        </div>
      </header>
      <div class="insight-grid">
        <div class="insight-card">
          <p class="insight-label">Nächster Einsatz</p>
          {% if next_shift_info %}
          <p class="insight-text">{{ next_shift_info.title }} am {{ next_shift_info.date_label }}{% if next_shift_info.hours %} • {{ next_shift_info.hours }} Std{% endif %}</p>
          {% else %}
          <p class="insight-text">Noch keine Einsätze geplant.</p>
          {% endif %}
        </div>
        <div class="insight-card">
          <p class="insight-label">Offene Anträge</p>
          <p class="insight-value">{{ personal_week_overview.pending_leaves }}</p>
          <p class="insight-text">Noch nicht freigegebene Abwesenheiten.</p>
        </div>
        <div class="insight-card">
          <p class="insight-label">Abwesenheitstage (7 Tage)</p>
          <p class="insight-value">{{ personal_week_overview.leave_days }}</p>
          <p class="insight-text">Geplante Tage ohne Einsatz im Zeitraum.</p>
        </div>
      </div>
    </article>
    {% endif %}
  </section>

  {% if is_admin %}
  <section class="dashboard-pulse" aria-label="Team Pulse">
    <header class="pulse-header">
      <div>
        <p class="pulse-eyebrow">Live-Status</p>
        <h2>Puls der Organisation</h2>
        <p class="pulse-description">
          {% if is_admin %}
            Alle Kennzahlen basieren auf realen Einsätzen und genehmigten Abwesenheiten der kommenden Woche.
          {% else %}
            Sieh sofort, wie viele Kolleg:innen eingeplant sind und welche Anträge noch offen sind.
          {% endif %}
        </p>
      </div>
      <div class="pulse-filters" role="group" aria-label="Darstellung wählen">
        <button class="pulse-filter is-active" type="button" data-target="pulse-capacity">Kapazität</button>
        <button class="pulse-filter" type="button" data-target="pulse-availability">Verfügbarkeit</button>
        <button class="pulse-filter" type="button" data-target="pulse-leave">Abwesenheiten</button>
      </div>
    </header>
    <div class="pulse-panels">
      <article class="pulse-panel is-active" id="pulse-capacity">
        <div class="pulse-metric">
          <span class="pulse-metric-label">Ø Abdeckung (7 Tage)</span>
          <div class="pulse-metric-value-wrapper">
            <span class="pulse-metric-value" data-count-to="{{ coverage_average }}">0</span>
            <span class="pulse-metric-unit">%</span>
          </div>
          <p class="pulse-metric-hint">{{ coverage_message }}</p>
          <div class="pulse-progress" style="--progress: {{ coverage_average }}%">
            <div class="pulse-progress-fill"></div>
          </div>
        </div>
        <ul class="pulse-highlights">
          {% for highlight in capacity_highlights %}
          <li>
            <span class="status-dot {% if highlight.coverage >= 80 %}status-success{% elif highlight.coverage >= 60 %}status-info{% else %}status-warning{% endif %}"></span>
            <div>
              <p class="pulse-highlight-title">{{ highlight.date_label }}</p>
              <p class="pulse-highlight-text">{{ highlight.scheduled }} von {{ highlight.available }} Personen eingeplant ({{ highlight.coverage }}%).</p>
            </div>
          </li>
          {% endfor %}
        </ul>
      </article>
      <article class="pulse-panel" id="pulse-availability">
        <div class="pulse-split">
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Heutige Verfügbarkeit</p>
            <h3>
              {% if coverage_today %}
              <span data-count-to="{{ coverage_today.available }}">0</span>
              {% else %}
              <span>0</span>
              {% endif %}
            </h3>
            <p class="pulse-tile-text">
              {% if coverage_today %}
                {{ coverage_today.scheduled }} Personen eingeplant, {{ coverage_today.on_leave }} in Abwesenheit.
              {% else %}
                Keine Einsätze für heute vorhanden.
              {% endif %}
            </p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Team im Urlaub (7 Tage)</p>
            <h3>
              <span data-count-to="{{ leave_status_overview.approved + leave_status_overview.pending }}">0</span>
            </h3>
            <p class="pulse-tile-text">Summe aller Abwesenheiten im Zeitraum.</p>
          </div>
        </div>
        <ul class="pulse-checklist">
          {% for entry in team_capacity[:3] %}
          <li>
            <span class="status-dot {% if entry.coverage >= 80 %}status-success{% elif entry.coverage >= 60 %}status-info{% else %}status-warning{% endif %}"></span>
            <div>
              <p class="pulse-highlight-title">{{ entry.date_label }}</p>
              <p class="pulse-highlight-text">{{ entry.scheduled }} Personen eingeplant • {{ entry.on_leave }} in Abwesenheit • {{ entry.hours }} Std.</p>
            </div>
          </li>
          {% endfor %}
        </ul>
      </article>
      <article class="pulse-panel" id="pulse-leave">
        <div class="pulse-split pulse-sentiment-grid">
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Genehmigte Anträge</p>
            <h3><span data-count-to="{{ leave_status_overview.approved }}">0</span></h3>
            <p class="pulse-tile-text">Echte Freigaben im Zeitraum {{ week_window_label }}.</p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Offene Anträge</p>
            <h3><span data-count-to="{{ leave_status_overview.pending }}">0</span></h3>
            <p class="pulse-tile-text">Noch zu prüfende Abwesenheiten.</p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Freigaberate (30 Tage)</p>
            <h3>
              {% if approval_rate is not none %}
              <span data-count-to="{{ approval_rate }}">0</span><span class="pulse-tile-unit">%</span>
              {% else %}
              <span>–</span>
              {% endif %}
            </h3>
            <p class="pulse-tile-text">Verhältnis genehmigter Anträge im letzten Monat.</p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Eigene Anträge offen</p>
            <h3><span data-count-to="{{ personal_week_overview.pending_leaves }}">0</span></h3>
            <p class="pulse-tile-text">Noch nicht bestätigte Abwesenheiten für dich.</p>
          </div>
        </div>
      </article>
    </div>
  </section>
  {% endif %}
</div>

<script id="dashboard-data" type="application/json">
  {{ {
    "weekChart": week_chart,
    "leaveStatus": leave_status_overview,
    "departmentDistribution": department_distribution,
    "teamCapacity": team_capacity
  } | tojson }}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha384-Tw1Y9qsK0kGugHgdGXN53BJ38qRAjPR9U1FVLtZL1NVr7DiIP9N6byN1Nsx3RpMB" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filters = document.querySelectorAll('.pulse-filter');
    const panels = document.querySelectorAll('.pulse-panel');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const datasetElement = document.getElementById('dashboard-data');
    let dashboardData = null;
    if (datasetElement) {
      try {
        dashboardData = JSON.parse(datasetElement.textContent);
      } catch (error) {
        console.warn('Dashboard-Daten konnten nicht geparst werden.', error);
      }
    }

    const formatNumber = (value) => {
      if (Number.isNaN(value)) {
        return '0';
      }
      if (Math.abs(value % 1) < 0.05) {
        return Math.round(value).toLocaleString('de-DE');
      }
      return value.toLocaleString('de-DE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    };

    const animateCounter = (element) => {
      if (!element || element.dataset.animated === 'true') {
        return;
      }

      const target = parseFloat(element.dataset.countTo);
      if (Number.isNaN(target)) {
        element.textContent = element.textContent || '0';
        element.dataset.animated = 'true';
        return;
      }

      if (prefersReducedMotion) {
        element.textContent = formatNumber(target);
        element.dataset.animated = 'true';
        return;
      }

      const duration = 900;
      const start = performance.now();

      const step = (currentTime) => {
        const elapsed = currentTime - start;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const value = target % 1 === 0 ? Math.round(target * eased) : target * eased;
        element.textContent = formatNumber(value);

        if (progress < 1) {
          window.requestAnimationFrame(step);
        } else {
          element.textContent = formatNumber(target);
        }
      };

      element.dataset.animated = 'true';
      window.requestAnimationFrame(step);
    };

    const animatePanel = (panel) => {
      if (!panel) {
        return;
      }

      panel.classList.add('is-animated');
      panel.querySelectorAll('[data-count-to]').forEach(animateCounter);
      panel.querySelectorAll('.pulse-progress').forEach((progressBar, index) => {
        progressBar.style.setProperty('--pulse-delay', `${index * 80}ms`);
        progressBar.classList.add('is-animated');
      });
      panel.querySelectorAll('.pulse-tile').forEach((tile, index) => {
        tile.style.setProperty('--pulse-delay', `${index * 80}ms`);
        tile.classList.add('is-animated');
      });
    };

    const activePanel = document.querySelector('.pulse-panel.is-active');
    if (activePanel) {
      animatePanel(activePanel);
    }

    filters.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.classList.contains('is-active')) {
          return;
        }

        const targetId = button.dataset.target;
        const targetPanel = document.getElementById(targetId);
        if (!targetPanel) {
          return;
        }

        filters.forEach((item) => {
          item.classList.toggle('is-active', item === button);
        });

        panels.forEach((panel) => {
          panel.classList.toggle('is-active', panel === targetPanel);
        });

        animatePanel(targetPanel);
      });
    });

    if (dashboardData && window.Chart) {
      const { weekChart, leaveStatus, departmentDistribution } = dashboardData;

      const hoursCanvas = document.getElementById('weekHoursChart');
      if (hoursCanvas) {
        new Chart(hoursCanvas, {
          type: 'bar',
          data: {
            labels: weekChart.labels,
            datasets: [
              {
                type: 'bar',
                label: 'Stunden gesamt',
                data: weekChart.hours,
                backgroundColor: 'rgba(37, 99, 235, 0.25)',
                borderColor: 'rgba(37, 99, 235, 0.6)',
                borderWidth: 1.5,
                borderRadius: 6,
              },
              {
                type: 'line',
                label: 'Eingesetzte Personen',
                data: weekChart.scheduled,
                borderColor: '#2563eb',
                backgroundColor: '#2563eb',
                tension: 0.35,
                fill: false,
                yAxisID: 'y1',
              },
              {
                type: 'line',
                label: 'Abwesenheiten',
                data: weekChart.on_leave,
                borderColor: '#dc2626',
                backgroundColor: '#dc2626',
                tension: 0.35,
                fill: false,
                borderDash: [6, 4],
                yAxisID: 'y1',
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Stunden',
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.25)',
                }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Personen',
                },
                grid: {
                  drawOnChartArea: false,
                }
              }
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    if (context.dataset.label === 'Stunden gesamt') {
                      return `${context.dataset.label}: ${formatNumber(context.parsed.y)} Std`;
                    }
                    return `${context.dataset.label}: ${context.parsed.y}`;
                  },
                },
              },
            },
          },
        });
      }

      const leaveStatusCanvas = document.getElementById('leaveStatusChart');
      if (leaveStatusCanvas && (leaveStatus.approved > 0 || leaveStatus.pending > 0)) {
        new Chart(leaveStatusCanvas, {
          type: 'doughnut',
          data: {
            labels: ['Genehmigt', 'Offen'],
            datasets: [
              {
                data: [leaveStatus.approved, leaveStatus.pending],
                backgroundColor: ['rgba(5, 150, 105, 0.85)', 'rgba(217, 119, 6, 0.85)'],
                borderWidth: 0,
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      const departmentCanvas = document.getElementById('departmentChart');
      const hasDepartmentData = Array.isArray(departmentDistribution) && departmentDistribution.some((entry) => entry.count > 0);
      if (departmentCanvas && hasDepartmentData) {
        new Chart(departmentCanvas, {
          type: 'doughnut',
          data: {
            labels: departmentDistribution.map((entry) => entry.name),
            datasets: [
              {
                data: departmentDistribution.map((entry) => entry.count),
                backgroundColor: [
                  'rgba(37, 99, 235, 0.8)',
                  'rgba(14, 165, 233, 0.8)',
                  'rgba(99, 102, 241, 0.8)',
                  'rgba(16, 185, 129, 0.8)',
                  'rgba(217, 119, 6, 0.8)',
                  'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 0,
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }
    }

    document.querySelectorAll('[data-count-to]').forEach((element) => {
      if (element.closest('.pulse-panel')) {
        return;
      }
      animateCounter(element);
    });
  });
</script>
{% endblock %}
