{% extends "layout.html" %}
{% block title %}Dashboard - Einsatzplaner{% endblock %}
{% block content %}
{% set is_admin = session.get('is_admin') %}
{% set is_system_admin = is_admin and (current_user and not current_user.department_id) %}
{% set current_user_id = current_user.id if current_user else None %}
{% set total_employees = employee_count or 0 %}
{% set pending_ratio = (pending_leaves / (total_employees if total_employees else 1)) * 100 %}
{% if total_employees == 0 %}
  {% set pending_ratio = 0 %}
{% endif %}
{% set pending_ratio = ([pending_ratio, 100] | min) %}
{% set pending_ratio = ([pending_ratio, 0] | max) %}
{% set coverage_score = 100 - pending_ratio %}
{% set coverage_score = ([coverage_score, 100] | min) %}
{% set coverage_score = ([coverage_score, 0] | max) %}
{% set available_people = total_employees - pending_leaves %}
{% set available_people = ([available_people, 0] | max) %}
{% set available_people = ([available_people, total_employees] | min) %}
{% if coverage_score > 75 %}
  {% set focus_score = 92 %}
  {% set satisfaction_score = 88 %}
{% elif coverage_score > 50 %}
  {% set focus_score = 84 %}
  {% set satisfaction_score = 82 %}
{% else %}
  {% set focus_score = 71 %}
  {% set satisfaction_score = 76 %}
{% endif %}
{% set response_speed = 'unter 24 Stunden' if is_admin else 'innerhalb von 2 Tagen' %}
{% set highlight_statement = 'EinsÃ¤tze bleiben stabil. Plane Feinjustierungen in den StoÃŸzeiten.' if coverage_score > 65 else 'Plane zusÃ¤tzliche Ressourcen fÃ¼r StoÃŸzeiten und gleiche EngpÃ¤sse aktiv aus.' %}
<div class="dashboard-page">
  <section class="dashboard-hero">
    <div class="dashboard-hero-main">
      <p class="hero-eyebrow">
        {% if is_system_admin %}
          Systemadministration
        {% elif is_admin %}
          Teamleitung & Planung
        {% else %}
          Mitarbeiterbereich
        {% endif %}
      </p>
      <h1>Hallo {{ current_user.name if current_user else 'Team' }} ğŸ‘‹</h1>
      <p class="hero-subtitle">
        {% if is_admin %}
          Behalte Ressourcen, offene AntrÃ¤ge und die ProduktivitÃ¤t deines Teams im Blick. Von hier aus erreichst du alle wichtigen Tools fÃ¼r eine moderne Einsatzplanung.
        {% else %}
          Dein persÃ¶nliches Cockpit fÃ¼r Schichten, UrlaubsantrÃ¤ge und Team-News. Mit wenigen Klicks bist du vorbereitet auf die kommende Woche.
        {% endif %}
      </p>
      <div class="dashboard-hero-actions">
        <a class="hero-action primary" href="{{ url_for('schedule') }}">
          <span class="hero-action-icon">ğŸ“…</span>
          Dienstplan Ã¶ffnen
        </a>
        {% if is_admin %}
          <a class="hero-action" href="{{ url_for('leave_requests') }}">
            <span class="hero-action-icon">ğŸ“</span>
            AntrÃ¤ge prÃ¼fen
          </a>
        {% else %}
          <a class="hero-action" href="{{ url_for('leave_form') }}">
            <span class="hero-action-icon">ğŸ“</span>
            Urlaub beantragen
          </a>
        {% endif %}
        {% if is_admin %}
          <a class="hero-action" href="{{ url_for('employees') }}">
            <span class="hero-action-icon">ğŸ‘¥</span>
            Team verwalten
          </a>
        {% else %}
          <a class="hero-action" href="{{ url_for('employee_hours_overview') }}">
            <span class="hero-action-icon">â±ï¸</span>
            Meine Stunden
          </a>
        {% endif %}
      </div>
    </div>
    <div class="dashboard-hero-aside">
      <div class="hero-highlight">
        <div class="highlight-icon">âš¡</div>
        <div>
          <p class="highlight-title">NÃ¤chste Schritte</p>
          <p class="highlight-text">
            {% if is_admin %}
              {{ pending_leaves }} offene AbwesenheitsantrÃ¤ge warten auf deine Entscheidung.
            {% else %}
              Checke deinen Einsatzplan und sichere dir rechtzeitig freie Tage.
            {% endif %}
          </p>
        </div>
      </div>
      {% if current_user and current_user.department %}
      <div class="hero-meta-card">
        <p class="meta-label">Meine Abteilung</p>
        <p class="meta-value">{{ current_user.department.name }}</p>
        {% if current_user.department.area %}
        <p class="meta-support">Bereich: {{ current_user.department.area }}</p>
        {% endif %}
      </div>
      {% elif is_system_admin %}
      <div class="hero-meta-card">
        <p class="meta-label">Organisation</p>
        <p class="meta-value">Alle Standorte</p>
        <p class="meta-support">VollstÃ¤ndige SystemÃ¼bersicht aktiv</p>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="dashboard-kpis" aria-label="Kennzahlen">
    <article class="kpi-card kpi-employees">
      <div class="kpi-icon">ğŸ‘¥</div>
      <div class="kpi-content">
        <p class="kpi-label">Aktive Mitarbeitende</p>
        <p class="kpi-value">{{ employee_count }}</p>
        <p class="kpi-helper">
          {% if is_admin %}
            VerfÃ¼gbarkeit & Einsatzbereitschaft im Blick behalten
          {% else %}
            Kolleginnen und Kollegen im aktuellen Team
          {% endif %}
        </p>
      </div>
      {% if is_admin %}
      <a class="kpi-link" href="{{ url_for('employees') }}">Team organisieren â†’</a>
      {% endif %}
    </article>

    <article class="kpi-card kpi-departments">
      <div class="kpi-icon">ğŸ¢</div>
      <div class="kpi-content">
        <p class="kpi-label">
          {% if is_admin %}
            Abteilungen gesamt
          {% else %}
            Einsatzbereich
          {% endif %}
        </p>
        <p class="kpi-value">{{ department_count }}</p>
        <p class="kpi-helper">
          {% if is_admin %}
            Struktur & Verantwortlichkeiten optimal ausbalancieren
          {% else %}
            Ãœberblick Ã¼ber deinen Einsatzkontext
          {% endif %}
        </p>
      </div>
      {% if is_admin %}
      <a class="kpi-link" href="{{ url_for('departments') }}">Bereiche verwalten â†’</a>
      {% else %}
      <a class="kpi-link" href="{{ url_for('employee_profile', emp_id=current_user_id) }}">Profil ansehen â†’</a>
      {% endif %}
    </article>

    <article class="kpi-card kpi-leaves">
      <div class="kpi-icon">ğŸ“‹</div>
      <div class="kpi-content">
        <p class="kpi-label">
          {% if is_admin %}
            Offene AntrÃ¤ge
          {% else %}
            Eigene AntrÃ¤ge
          {% endif %}
        </p>
        <p class="kpi-value">{{ pending_leaves }}</p>
        <p class="kpi-helper">
          {% if is_admin %}
            Koordiniere Urlaube & Abwesenheiten ohne MedienbrÃ¼che
          {% else %}
            Bleibe informiert Ã¼ber den Status deiner Urlaubsplanung
          {% endif %}
        </p>
      </div>
      {% if is_admin %}
      <a class="kpi-link" href="{{ url_for('leave_requests') }}">AntrÃ¤ge bearbeiten â†’</a>
      {% else %}
      <a class="kpi-link" href="{{ url_for('leave_form') }}">Neuen Antrag stellen â†’</a>
      {% endif %}
    </article>
  </section>

  <section class="dashboard-actions" aria-label="Schnellzugriffe">
    {% if is_admin %}
    <article class="action-card">
      <div class="action-icon">ğŸ¤–</div>
      <div class="action-content">
        <h3>Auto-Schichten</h3>
        <p>Erzeuge VorschlÃ¤ge fÃ¼r optimale DienstplÃ¤ne â€“ abgestimmt auf KapazitÃ¤ten und PrioritÃ¤ten.</p>
      </div>
      <a class="action-link" href="{{ url_for('auto_schedule_form') }}">Jetzt planen</a>
    </article>
    <article class="action-card">
      <div class="action-icon">âš™ï¸</div>
      <div class="action-content">
        <h3>ProduktivitÃ¤t steuern</h3>
        <p>Lege Kennzahlen pro Abteilung fest und vergleiche Soll- und Ist-Stunden.</p>
      </div>
      <a class="action-link" href="{{ url_for('productivity_settings') }}">Einstellungen Ã¶ffnen</a>
    </article>
    <article class="action-card">
      <div class="action-icon">ğŸ“ˆ</div>
      <div class="action-content">
        <h3>Monatsreport</h3>
        <p>Auswertungen und Trends fÃ¼r transparente Kommunikation mit Stakeholdern.</p>
      </div>
      <a class="action-link" href="{{ url_for('monthly_report') }}">Bericht ansehen</a>
    </article>
    {% else %}
    <article class="action-card">
      <div class="action-icon">ğŸ—“ï¸</div>
      <div class="action-content">
        <h3>Meine Schichten</h3>
        <p>Plane deine Woche und behalte FrÃ¼h-, SpÃ¤t- und Sonderdienste im Blick.</p>
      </div>
      <a class="action-link" href="{{ url_for('schedule') }}">Zum Dienstplan</a>
    </article>
    <article class="action-card">
      <div class="action-icon">ğŸ–ï¸</div>
      <div class="action-content">
        <h3>Abwesenheit melden</h3>
        <p>Stelle UrlaubsantrÃ¤ge oder informiere dein Team Ã¼ber geplante Abwesenheiten.</p>
      </div>
      <a class="action-link" href="{{ url_for('leave_form') }}">Antrag stellen</a>
    </article>
    <article class="action-card">
      <div class="action-icon">ğŸ’¬</div>
      <div class="action-content">
        <h3>Profil & Kontakt</h3>
        <p>Aktualisiere deine Erreichbarkeit und finde die richtigen Ansprechpartner.</p>
      </div>
      <a class="action-link" href="{{ url_for('employee_profile', emp_id=current_user_id) }}">Profil Ã¶ffnen</a>
    </article>
    {% endif %}
  </section>

  <section class="dashboard-panels">
    <article class="dashboard-panel">
      <header class="panel-header">
        <div>
          <p class="panel-eyebrow">Aktuelles</p>
          <h2>{% if is_admin %}PrioritÃ¤ten heute{% else %}Meine nÃ¤chsten Schritte{% endif %}</h2>
        </div>
      </header>
      <ul class="panel-list">
        <li>
          <span class="status-dot {% if pending_leaves > 0 %}status-warning{% else %}status-success{% endif %}"></span>
          <div>
            <p class="list-title">
              {% if is_admin %}
                Offene Abwesenheiten
              {% else %}
                Urlaubsstatus prÃ¼fen
              {% endif %}
            </p>
            <p class="list-subtitle">
              {% if is_admin %}
                {{ pending_leaves }} AntrÃ¤ge warten auf RÃ¼ckmeldung
              {% else %}
                Bleibe informiert: {{ pending_leaves }} AntrÃ¤ge noch in Bearbeitung
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('leave_requests') if is_admin else url_for('leave_form') }}">
            {% if is_admin %}Ansehen{% else %}Status anzeigen{% endif %}
          </a>
        </li>
        <li>
          <span class="status-dot status-info"></span>
          <div>
            <p class="list-title">Dienstplan aktualisieren</p>
            <p class="list-subtitle">
              {% if is_admin %}
                PrÃ¼fe EngpÃ¤sse und gleiche KapazitÃ¤ten Ã¼ber Abteilungen hinweg aus
              {% else %}
                Sichere dir Wunschschichten frÃ¼hzeitig und bleibe flexibel
              {% endif %}
            </p>
          </div>
          <a class="panel-link" href="{{ url_for('schedule') }}">Ã–ffnen</a>
        </li>
        {% if is_admin %}
        <li>
          <span class="status-dot status-neutral"></span>
          <div>
            <p class="list-title">Teamkommunikation</p>
            <p class="list-subtitle">Informiere Kolleg:innen Ã¼ber Ã„nderungen und neue PrioritÃ¤ten</p>
          </div>
          <a class="panel-link" href="{{ url_for('shift_requests_overview') }}">Ãœbersicht</a>
        </li>
        {% else %}
        <li>
          <span class="status-dot status-neutral"></span>
          <div>
            <p class="list-title">Profil aktualisieren</p>
            <p class="list-subtitle">Halte Telefonnummer und bevorzugte Einsatzzeiten aktuell</p>
          </div>
          <a class="panel-link" href="{{ url_for('employee_profile', emp_id=current_user_id) }}">Bearbeiten</a>
        </li>
        {% endif %}
      </ul>
    </article>

    <article class="dashboard-panel accent">
      <header class="panel-header">
        <div>
          <p class="panel-eyebrow">Insights</p>
          <h2>{% if is_admin %}Team & Ressourcen{% else %}Wissenswertes{% endif %}</h2>
        </div>
      </header>
      <div class="insight-grid">
        <div class="insight-card">
          <p class="insight-label">Auslastung</p>
          <p class="insight-value">
            {% if employee_count > 0 %}
              {{ 'Hoch' if pending_leaves / (employee_count or 1) > 0.2 else 'Stabil' }}
            {% else %}
              Keine Daten
            {% endif %}
          </p>
          <p class="insight-text">
            {% if is_admin %}
              Nutze KapazitÃ¤tsdaten, um EngpÃ¤sse frÃ¼hzeitig zu erkennen und gegenzusteuern.
            {% else %}
              Plane Urlaub abgestimmt auf Team-KapazitÃ¤ten fÃ¼r eine faire Verteilung.
            {% endif %}
          </p>
        </div>
        <div class="insight-card">
          <p class="insight-label">Fokus dieser Woche</p>
          <p class="insight-value">{{ 'Planung optimieren' if is_admin else 'Transparente Kommunikation' }}</p>
          <p class="insight-text">
            {% if is_admin %}
              Stimme dich mit Teamleitungen ab und halte Stakeholder mit Berichten auf dem Laufenden.
            {% else %}
              Teile frÃ¼hzeitig VerfÃ¼gbarkeiten und tausche dich mit deinem Team zu Schichten aus.
            {% endif %}
          </p>
        </div>
        <div class="insight-card">
          <p class="insight-label">Tipps</p>
          <p class="insight-value">Proaktiv handeln</p>
          <p class="insight-text">
            {% if is_admin %}
              Nutze Auto-Schichten als Ausgangspunkt und individualisiere EinsÃ¤tze fÃ¼r Spitzenzeiten.
            {% else %}
              PrÃ¼fe den Dienstplan regelmÃ¤ÃŸig, um spontane Ã„nderungen nicht zu verpassen.
            {% endif %}
          </p>
        </div>
      </div>
    </article>
  </section>

  <section class="dashboard-pulse" aria-label="Team Pulse">
    <header class="pulse-header">
      <div>
        <p class="pulse-eyebrow">Live-Status</p>
        <h2>Puls der Organisation</h2>
        <p class="pulse-description">
          {% if is_admin %}
            Interaktive Kennzahlen unterstÃ¼tzen dich bei Entscheidungen zu KapazitÃ¤ten, Stimmung und offenen Aufgaben.
          {% else %}
            Behalte deine EinsÃ¤tze, VerfÃ¼gbarkeiten und die Stimmung im Team im Blick â€“ alles live aktualisiert.
          {% endif %}
        </p>
      </div>
      <div class="pulse-filters" role="group" aria-label="Darstellung wÃ¤hlen">
        <button class="pulse-filter is-active" type="button" data-target="pulse-capacity">KapazitÃ¤t</button>
        <button class="pulse-filter" type="button" data-target="pulse-availability">VerfÃ¼gbarkeit</button>
        <button class="pulse-filter" type="button" data-target="pulse-sentiment">TeamgefÃ¼hl</button>
      </div>
    </header>
    <div class="pulse-panels">
      <article class="pulse-panel is-active" id="pulse-capacity">
        <div class="pulse-metric">
          <span class="pulse-metric-label">Abgedeckte Schichten</span>
          <div class="pulse-metric-value-wrapper">
            <span class="pulse-metric-value" data-count-to="{{ coverage_score|round(0, 'floor')|int }}">0</span>
            <span class="pulse-metric-unit">%</span>
          </div>
          <p class="pulse-metric-hint">{{ highlight_statement }}</p>
          <div class="pulse-progress" style="--progress: {{ coverage_score|round(0, 'floor')|int }}%">
            <div class="pulse-progress-fill"></div>
          </div>
        </div>
        <ul class="pulse-highlights">
          <li>
            <span class="status-dot {% if pending_leaves > 0 %}status-warning{% else %}status-success{% endif %}"></span>
            <div>
              <p class="pulse-highlight-title">
                {% if is_admin %}
                  {{ pending_leaves }} offene AntrÃ¤ge
                {% else %}
                  {{ pending_leaves }} offene RÃ¼ckmeldungen
                {% endif %}
              </p>
              <p class="pulse-highlight-text">
                {% if is_admin %}
                  Priorisiere Freigaben, um EngpÃ¤sse frÃ¼hzeitig zu entschÃ¤rfen.
                {% else %}
                  Bleibe proaktiv: Halte dein Team Ã¼ber Wunschschichten und AntrÃ¤ge auf dem Laufenden.
                {% endif %}
              </p>
            </div>
          </li>
          <li>
            <span class="status-dot status-info"></span>
            <div>
              <p class="pulse-highlight-title">Fokus-Index</p>
              <p class="pulse-highlight-value">
                <span data-count-to="{{ focus_score|int }}">0</span>
                <span class="pulse-highlight-unit">%</span>
              </p>
              <p class="pulse-highlight-text">
                {% if is_admin %}
                  Nutze KapazitÃ¤tsdaten, um Teams zielgerichtet fÃ¼r anstehende Projekte auszurichten.
                {% else %}
                  Stimme WÃ¼nsche frÃ¼hzeitig mit deiner Leitung ab und sichere dir Wunschschichten.
                {% endif %}
              </p>
            </div>
          </li>
          <li>
            <span class="status-dot status-neutral"></span>
            <div>
              <p class="pulse-highlight-title">Reaktionszeit</p>
              <p class="pulse-highlight-value">{{ response_speed }}</p>
              <p class="pulse-highlight-text">
                {% if is_admin %}
                  Transparente RÃ¼ckmeldungen schaffen Vertrauen im Team.
                {% else %}
                  Teile Updates, damit Entscheidungen schneller getroffen werden kÃ¶nnen.
                {% endif %}
              </p>
            </div>
          </li>
        </ul>
      </article>
      <article class="pulse-panel" id="pulse-availability">
        <div class="pulse-split">
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">VerfÃ¼gbarkeit</p>
            <h3>
              <span data-count-to="{{ available_people|int }}">0</span>
              <span class="pulse-tile-separator">/</span>
              {{ total_employees }}
            </h3>
            <p class="pulse-tile-text">
              {% if is_admin %}
                Mitarbeitende sind aktuell einsatzbereit. Plane Vertretungen fÃ¼r Abwesenheiten rechtzeitig ein.
              {% else %}
                Kolleg:innen stehen fÃ¼r Schichttausch bereit â€“ nutze ruhige Zeiten fÃ¼r Abstimmungen.
              {% endif %}
            </p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">AktivitÃ¤t</p>
            <h3>
              {% if total_employees %}
              <span data-count-to="{{ pending_ratio|round(0, 'floor')|int }}">0</span><span class="pulse-tile-unit">%</span>
              {% else %}
              <span>0</span><span class="pulse-tile-unit">%</span>
              {% endif %}
            </h3>
            <p class="pulse-tile-text">
              {% if is_admin %}
                Anteil der Teammitglieder mit offenen Abwesenheiten in dieser Woche.
              {% else %}
                Zeigt, wie viele Anfragen aktuell bearbeitet werden und wie dynamisch die Planung ist.
              {% endif %}
            </p>
          </div>
        </div>
        <ul class="pulse-checklist">
          <li>
            <span class="status-dot status-success"></span>
            <div>
              <p class="pulse-highlight-title">Schichtabdeckung prÃ¼fen</p>
              <p class="pulse-highlight-text">
                {% if is_admin %}
                  Gleiche KapazitÃ¤ten zwischen Abteilungen aus und dokumentiere Anpassungen transparent.
                {% else %}
                  Aktualisiere deine Einsatzzeiten, um verlÃ¤ssliche Ãœbersichten fÃ¼r die Leitung zu ermÃ¶glichen.
                {% endif %}
              </p>
            </div>
          </li>
          <li>
            <span class="status-dot status-info"></span>
            <div>
              <p class="pulse-highlight-title">Kommunikation synchronisieren</p>
              <p class="pulse-highlight-text">
                {% if is_admin %}
                  Informiere Teams Ã¼ber aktuelle PrioritÃ¤ten und bestÃ¤tigte Ã„nderungen unmittelbar im System.
                {% else %}
                  Nutze Chat und Kommentare, um schnelle RÃ¼ckfragen zu klÃ¤ren.
                {% endif %}
              </p>
            </div>
          </li>
        </ul>
      </article>
      <article class="pulse-panel" id="pulse-sentiment">
        <div class="pulse-split pulse-sentiment-grid">
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Teamzufriedenheit</p>
            <h3>
              <span data-count-to="{{ satisfaction_score|int }}">0</span>
              <span class="pulse-tile-unit">%</span>
            </h3>
            <p class="pulse-tile-text">
              {% if is_admin %}
                Hohe Zufriedenheit entsteht durch transparente DienstplÃ¤ne und schnelle Genehmigungen.
              {% else %}
                Teile Feedback zu Schichten und melde WÃ¼nsche frÃ¼hzeitig, um das Stimmungsbild zu stÃ¤rken.
              {% endif %}
            </p>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Highlights</p>
            <ul class="pulse-mini-list">
              <li>
                <span>ğŸ’¡</span>
                <div>
                  <p>Arbeitsbelastung</p>
                  <p class="pulse-mini-text">
                    {% if coverage_score > 70 %}
                      GleichmÃ¤ÃŸig verteilt â€“ perfekter Zeitpunkt fÃ¼r Optimierungen.
                    {% else %}
                      EngpÃ¤sse sichtbar â€“ plane zusÃ¤tzliche UnterstÃ¼tzung.
                    {% endif %}
                  </p>
                </div>
              </li>
              <li>
                <span>ğŸ¤</span>
                <div>
                  <p>Teamspirit</p>
                  <p class="pulse-mini-text">
                    {% if is_admin %}
                      Gemeinsame Reviews stÃ¤rken Vertrauen und Transparenz.
                    {% else %}
                      Kurze Abstimmungen vor Dienstbeginn halten alle informiert.
                    {% endif %}
                  </p>
                </div>
              </li>
            </ul>
          </div>
          <div class="pulse-tile">
            <p class="pulse-tile-eyebrow">Empfehlung</p>
            <p class="pulse-recommendation">
              {% if is_admin %}
                Nutze regelmÃ¤ÃŸige Check-ins, um Feedback zur Planung einzuholen und Trends frÃ¼h zu erkennen.
              {% else %}
                Teile VerbesserungsvorschlÃ¤ge direkt Ã¼ber das Portal â€“ deine Stimme gestaltet den Plan aktiv mit.
              {% endif %}
            </p>
          </div>
        </div>
      </article>
    </div>
  </section>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filters = document.querySelectorAll('.pulse-filter');
    const panels = document.querySelectorAll('.pulse-panel');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const formatNumber = (value) => {
      if (Number.isNaN(value)) {
        return '0';
      }
      if (Math.abs(value % 1) < 0.05) {
        return Math.round(value).toLocaleString('de-DE');
      }
      return value.toLocaleString('de-DE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    };

    const animateCounter = (element) => {
      if (!element || element.dataset.animated === 'true') {
        return;
      }

      const target = parseFloat(element.dataset.countTo);
      if (Number.isNaN(target)) {
        element.textContent = element.textContent || '0';
        element.dataset.animated = 'true';
        return;
      }

      if (prefersReducedMotion) {
        element.textContent = formatNumber(target);
        element.dataset.animated = 'true';
        return;
      }

      const duration = 900;
      const start = performance.now();

      const step = (currentTime) => {
        const elapsed = currentTime - start;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const value = target % 1 === 0 ? Math.round(target * eased) : target * eased;
        element.textContent = formatNumber(value);

        if (progress < 1) {
          window.requestAnimationFrame(step);
        } else {
          element.textContent = formatNumber(target);
        }
      };

      element.dataset.animated = 'true';
      window.requestAnimationFrame(step);
    };

    const animatePanel = (panel) => {
      if (!panel) {
        return;
      }

      panel.classList.add('is-animated');
      panel.querySelectorAll('[data-count-to]').forEach(animateCounter);
      panel.querySelectorAll('.pulse-progress').forEach((progressBar, index) => {
        progressBar.style.setProperty('--pulse-delay', `${index * 80}ms`);
        progressBar.classList.add('is-animated');
      });
      panel.querySelectorAll('.pulse-tile').forEach((tile, index) => {
        tile.style.setProperty('--pulse-delay', `${index * 80}ms`);
        tile.classList.add('is-animated');
      });
    };

    const activePanel = document.querySelector('.pulse-panel.is-active');
    if (activePanel) {
      animatePanel(activePanel);
    }

    filters.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.classList.contains('is-active')) {
          return;
        }

        const targetId = button.dataset.target;
        const targetPanel = document.getElementById(targetId);
        if (!targetPanel) {
          return;
        }

        filters.forEach((item) => {
          item.classList.toggle('is-active', item === button);
        });

        panels.forEach((panel) => {
          panel.classList.toggle('is-active', panel === targetPanel);
        });

        animatePanel(targetPanel);
      });
    });
  });
</script>
{% endblock %}

