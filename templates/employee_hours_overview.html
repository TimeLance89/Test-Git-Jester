{% extends "layout.html" %}

{% block title %}Meine Stunden{% endblock %}

{% block content %}
<div class="dashboard-page hours-dashboard" aria-labelledby="hours-overview-heading">
  <section class="dashboard-hero">
    <div class="dashboard-hero-main">
      <p class="hero-eyebrow">Persönliches Stundenboard</p>
      <h1 id="hours-overview-heading">Ihre Stunden im {{ "%02d"|format(current_month) }}/{{ current_year }}</h1>
      <p class="hero-subtitle">
        Sie haben bereits <strong>{{ "%.1f"|format(hours_summary.worked_hours) }} Stunden</strong> erfasst und
        steuern auf <strong>{{ "%.1f"|format(hours_summary.target_hours) }} Stunden</strong> Monatsziel zu.
      </p>
      <div class="dashboard-hero-actions">
        <a class="hero-action primary" href="{{ url_for('schedule') }}">
          <span class="hero-action-icon" aria-hidden="true">📅</span>
          Dienstplan öffnen
        </a>
        <a class="hero-action" href="{{ url_for('leave_form') }}">
          <span class="hero-action-icon" aria-hidden="true">📝</span>
          Abwesenheit beantragen
        </a>
      </div>
      {% set progress_value = hours_summary.completion_percentage %}
      <div class="hours-progress" role="presentation">
        <div class="hours-progress-labels">
          <span>Fortschritt zu anteiligen Soll-Stunden</span>
          <span>{{ "%.1f"|format(progress_value) }}%</span>
        </div>
        <div class="hours-progress-bar" aria-hidden="true">
          <div class="hours-progress-fill" style="width: {{ "%.1f"|format(progress_value if progress_value < 100 else 100) }}%;"></div>
        </div>
        <p class="hours-progress-helper">
          Noch {{ "%.1f"|format(hours_summary.remaining_hours) }} Stunden · {{ remaining_workdays }} verbleibende Arbeitstage
        </p>
      </div>
    </div>
    <aside class="dashboard-hero-aside" aria-label="Zusammenfassung">
      {% if busiest_weekday %}
      <div class="hero-highlight">
        <div class="highlight-icon" aria-hidden="true">🔥</div>
        <div>
          <p class="highlight-title">Produktivster Tag</p>
          <p class="highlight-text">{{ busiest_weekday.name }} · {{ "%.1f"|format(busiest_weekday.hours) }}h insgesamt.</p>
        </div>
      </div>
      {% endif %}
      {% if dominant_shift_type %}
      <div class="hero-highlight hero-highlight-alt">
        <div class="highlight-icon" aria-hidden="true">⚙️</div>
        <div>
          <p class="highlight-title">Häufigste Schicht</p>
          <p class="highlight-text">{{ dominant_shift_type.name }} · {{ "%.1f"|format(dominant_shift_type.hours) }}h im aktuellen Monat.</p>
        </div>
      </div>
      {% endif %}
      <div class="hero-meta-card">
        <p class="meta-label">Durchschnitt pro Arbeitstag</p>
        <p class="meta-value">{{ "%.1f"|format(average_daily_hours) }}h</p>
        <p class="meta-support">Auf {{ worked_days_count }}{% if worked_days_count == 1 %} Einsatztag{% else %} Einsatztagen{% endif %} basierend.</p>
      </div>
      <div class="hero-meta-card">
        <p class="meta-label">Abwesenheiten</p>
        <p class="meta-value">{{ total_leave_days }} Tage</p>
        {% if vacation_days %}
        <p class="meta-support">Davon {{ vacation_days }} Tage Urlaub.</p>
        {% else %}
        <p class="meta-support">Keine Urlaubstage im aktuellen Monat erfasst.</p>
        {% endif %}
      </div>
    </aside>
  </section>

  <section class="hours-metrics" aria-labelledby="hours-metrics-heading">
    <div class="section-header">
      <div>
        <h2 id="hours-metrics-heading">Monatliche Kennzahlen</h2>
        <p>Alle wichtigen Zahlen auf einen Blick – transparent, strukturiert und jederzeit aktuell.</p>
      </div>
      <span class="section-pill">Aktueller Monat</span>
    </div>
    <div class="hours-metric-grid">
      <article class="hours-metric-card accent">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">🎯</span>
          <div>
            <h3>Geplante Soll-Stunden</h3>
            <p>Vertragliche Monatsstunden als Zielmarke.</p>
          </div>
        </div>
        <p class="metric-value">{{ "%.1f"|format(hours_summary.target_hours) }}h</p>
        <p class="metric-footnote">Fortschritt zum Monatsziel: {{ "%.1f"|format(completion_to_target) }}%</p>
      </article>
      <article class="hours-metric-card">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">📆</span>
          <div>
            <h3>Anteilige Soll-Stunden</h3>
            <p>Bis heute erforderliche Stunden.</p>
          </div>
        </div>
        <p class="metric-value">{{ "%.1f"|format(hours_summary.proportional_target) }}h</p>
        <p class="metric-footnote">Auf {{ hours_summary.get('workdays_passed', 0) }} von {{ hours_summary.get('total_workdays', 0) }} Arbeitstagen basiert.</p>
      </article>
      <article class="hours-metric-card">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">⚡</span>
          <div>
            <h3>Geleistete Stunden</h3>
            <p>Erfasste und genehmigte Arbeitszeit.</p>
          </div>
        </div>
        <p class="metric-value">{{ "%.1f"|format(hours_summary.worked_hours) }}h</p>
        {% if hours_delta is not none %}
        <p class="metric-footnote">
          {% if hours_delta >= 0 %}
          <span class="trend-indicator positive">▲ +{{ "%.1f"|format(hours_delta) }}h</span>
          {% else %}
          <span class="trend-indicator negative">▼ {{ "%.1f"|format(hours_delta) }}h</span>
          {% endif %}
          gegenüber {{ previous_month_label }}.
        </p>
        {% else %}
        <p class="metric-footnote">Keine Vergleichsdaten aus dem Vormonat verfügbar.</p>
        {% endif %}
      </article>
      <article class="hours-metric-card">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">🧭</span>
          <div>
            <h3>Reststunden</h3>
            <p>Bis zum Soll noch zu leisten.</p>
          </div>
        </div>
        <p class="metric-value">{{ "%.1f"|format(hours_summary.remaining_hours) }}h</p>
        <p class="metric-footnote">{{ remaining_workdays }} verbleibende Arbeitstage im Monat.</p>
      </article>
      <article class="hours-metric-card">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">⏱️</span>
          <div>
            <h3>{% if employee.position != 'Vollzeit' %}Überstunden{% else %}Puffer zum Ziel{% endif %}</h3>
            <p>Zusätzliche oder freie Stunden.</p>
          </div>
        </div>
        <p class="metric-value">{{ "%.1f"|format(hours_summary.overtime_hours) }}h</p>
        {% if employee.position != 'Vollzeit' %}
        <p class="metric-footnote">Über die anteiligen Soll-Stunden hinaus.</p>
        {% else %}
        <p class="metric-footnote">Positive Werte zeigen freie Kapazität.</p>
        {% endif %}
      </article>
      <article class="hours-metric-card">
        <div class="metric-headline">
          <span class="metric-icon" aria-hidden="true">📊</span>
          <div>
            <h3>Schichteinsätze</h3>
            <p>Genehmigte Schichten im Monat.</p>
          </div>
        </div>
        <p class="metric-value">{{ hours_summary.shift_count }}</p>
        <p class="metric-footnote">Ø {{ "%.1f"|format(average_daily_hours) }}h pro Einsatztag.</p>
      </article>
    </div>
  </section>

  <section class="hours-insights" aria-labelledby="hours-insights-heading">
    <div class="section-header">
      <div>
        <h2 id="hours-insights-heading">Verläufe &amp; Verteilungen</h2>
        <p>Moderne Visualisierungen zeigen Trends, Schwerpunkte und freie Potenziale.</p>
      </div>
      {% if current_month_label %}
      <span class="section-pill">{{ current_month_label }}</span>
      {% endif %}
    </div>
    <div class="hours-visual-grid">
      <article class="hours-chart-card span-2">
        <div class="chart-card-header">
          <div>
            <h3>Stundenentwicklung der letzten 12 Monate</h3>
            {% if hours_delta is not none and previous_month_label %}
            <p class="chart-subtitle">
              {% if hours_delta >= 0 %}
              <span class="trend-indicator positive">▲ {{ "%.1f"|format(hours_delta) }}h</span>
              {% else %}
              <span class="trend-indicator negative">▼ {{ "%.1f"|format(hours_delta|abs) }}h</span>
              {% endif %}
              gegenüber {{ previous_month_label }}.
              {% if hours_delta_percentage is not none %}
              ({{ "%.1f"|format(hours_delta_percentage) }}%)
              {% endif %}
            </p>
            {% else %}
            <p class="chart-subtitle">Verlauf Ihrer geleisteten Stunden im Jahresvergleich.</p>
            {% endif %}
          </div>
        </div>
        <canvas id="monthlyHoursChart" aria-label="Stundenentwicklung"></canvas>
      </article>
      <article class="hours-chart-card">
        <div class="chart-card-header">
          <div>
            <h3>Wochentagsverteilung</h3>
            <p class="chart-subtitle">Wann fallen Ihre Einsätze hauptsächlich an?</p>
          </div>
        </div>
        <canvas id="weekdayHoursChart" aria-label="Verteilung der Stunden nach Wochentag"></canvas>
        <ul class="hours-mini-list">
          {% for entry in weekday_breakdown[:4] %}
          <li>
            <span class="mini-list-label">{{ entry.name }}</span>
            <span class="mini-list-value">{{ "%.1f"|format(entry.hours) }}h</span>
          </li>
          {% endfor %}
        </ul>
      </article>
      <article class="hours-chart-card">
        <div class="chart-card-header">
          <div>
            <h3>Schichtarten</h3>
            <p class="chart-subtitle">Ihre Verteilung nach Schichttyp.</p>
          </div>
        </div>
        <canvas id="shiftTypeHoursChart" aria-label="Verteilung der Stunden nach Schichtart"></canvas>
        <ul class="hours-mini-list">
          {% for entry in shift_type_breakdown[:4] %}
          <li>
            <span class="mini-list-label">{{ entry.name }}</span>
            <span class="mini-list-value">{{ "%.1f"|format(entry.hours) }}h</span>
          </li>
          {% endfor %}
        </ul>
      </article>
    </div>
  </section>

  <section class="hours-details" aria-labelledby="hours-details-heading">
    <div class="section-header">
      <div>
        <h2 id="hours-details-heading">Details zu Schichten &amp; Abwesenheiten</h2>
        <p>Vollständige Transparenz über jeden Einsatz und jede Abwesenheit im aktuellen Monat.</p>
      </div>
    </div>
    <div class="hours-detail-grid">
      <article class="detail-panel" aria-labelledby="shift-details-heading">
        <div class="detail-panel-header">
          <div>
            <h3 id="shift-details-heading">Geleistete Schichten</h3>
            <p>{{ hours_summary.shift_count }} genehmigte Schichten in diesem Monat.</p>
          </div>
        </div>
        {% if hours_summary.shifts_detail %}
        <div class="detail-table-wrapper">
          <table class="detail-table" role="grid">
            <thead>
              <tr>
                <th scope="col">Datum</th>
                <th scope="col">Stunden</th>
                <th scope="col">Schichtart</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for shift in hours_summary.shifts_detail %}
              <tr>
                <td data-title="Datum">{{ shift.date.strftime('%d.%m.%Y') }}</td>
                <td data-title="Stunden">{{ "%.1f"|format(shift.hours) }}h</td>
                <td data-title="Schichtart">{{ shift.shift_type or 'N/A' }}</td>
                <td data-title="Status">{% if shift.approved %}Genehmigt{% else %}Offen{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="hours-empty-state">Bisher wurden keine Schichten in diesem Monat erfasst.</p>
        {% endif %}
      </article>
      <article class="detail-panel" aria-labelledby="leave-details-heading">
        <div class="detail-panel-header">
          <div>
            <h3 id="leave-details-heading">Abwesenheiten</h3>
            {% if total_leave_days %}
            <p>{{ total_leave_days }} Tage Abwesenheit, davon {{ vacation_days }} Tage Urlaub.</p>
            {% else %}
            <p>Im aktuellen Monat wurden keine Abwesenheiten registriert.</p>
            {% endif %}
          </div>
        </div>
        {% if hours_summary.leaves_detail %}
        <div class="detail-table-wrapper">
          <table class="detail-table" role="grid">
            <thead>
              <tr>
                <th scope="col">Start</th>
                <th scope="col">Ende</th>
                <th scope="col">Typ</th>
                <th scope="col">Status</th>
                <th scope="col">Notizen</th>
              </tr>
            </thead>
            <tbody>
              {% for leave in hours_summary.leaves_detail %}
              <tr>
                <td data-title="Start">{{ leave.start_date.strftime('%d.%m.%Y') }}</td>
                <td data-title="Ende">{{ leave.end_date.strftime('%d.%m.%Y') }}</td>
                <td data-title="Typ">{{ leave.leave_type }}</td>
                <td data-title="Status">{% if leave.approved %}Genehmigt{% else %}Offen{% endif %}</td>
                <td data-title="Notizen">{{ leave.notes or '–' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="hours-empty-state">Keine Abwesenheiten für diesen Monat eingetragen.</p>
        {% endif %}
      </article>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const palette = {
      primary: '#2563eb',
      secondary: '#14b8a6',
      accent: '#f97316',
      neutral: '#94a3b8',
      surface: '#ffffff',
    };

    Chart.defaults.font.family = 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    Chart.defaults.color = '#1e293b';

    // Monatsdiagramm
    const monthlyCtx = document.getElementById('monthlyHoursChart');
    if (monthlyCtx) {
      const monthlyData = {{ monthly_data | tojson }};
      const monthlyLabels = monthlyData.map(data => data.month_year);
      const monthlyWorkedHours = monthlyData.map(data => data.worked_hours);
      const monthlyTargetHours = monthlyData.map(data => data.target_hours);
      const monthlyProportionalTarget = monthlyData.map(data => data.proportional_target);

      new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthlyLabels,
          datasets: [
            {
              label: 'Geleistete Stunden',
              data: monthlyWorkedHours,
              backgroundColor: palette.primary,
              borderRadius: 6,
              maxBarThickness: 36,
            },
            {
              label: 'Soll-Stunden (Monat)',
              data: monthlyTargetHours,
              type: 'line',
              borderColor: palette.secondary,
              backgroundColor: 'transparent',
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 3,
            },
            {
              label: 'Anteilige Soll-Stunden',
              data: monthlyProportionalTarget,
              type: 'line',
              borderColor: palette.accent,
              backgroundColor: 'transparent',
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 3,
              borderDash: [6, 6],
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Stunden'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.2)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y + 'h';
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Wochentagsdiagramm
    const weekdayCtx = document.getElementById('weekdayHoursChart');
    if (weekdayCtx) {
      const weekdayHours = {{ weekday_hours | tojson }};
      const weekdayLabels = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
      const weekdayData = weekdayLabels.map((_, index) => weekdayHours[index] || 0);

      new Chart(weekdayCtx, {
        type: 'doughnut',
        data: {
          labels: weekdayLabels,
          datasets: [{
            data: weekdayData,
            backgroundColor: [
              palette.primary,
              '#4f46e5',
              palette.secondary,
              '#0ea5e9',
              palette.accent,
              '#facc15',
              palette.neutral
            ],
            borderWidth: 0,
            hoverOffset: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '58%',
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}h`;
                }
              }
            }
          }
        }
      });
    }

    // Schichtarten
    const shiftTypeCtx = document.getElementById('shiftTypeHoursChart');
    if (shiftTypeCtx) {
      const shiftTypeHours = {{ shift_type_hours | tojson }};
      const shiftTypeLabels = Object.keys(shiftTypeHours);
      const shiftTypeData = Object.values(shiftTypeHours);

      new Chart(shiftTypeCtx, {
        type: 'polarArea',
        data: {
          labels: shiftTypeLabels,
          datasets: [{
            data: shiftTypeData,
            backgroundColor: [
              palette.primary,
              palette.secondary,
              palette.accent,
              '#10b981',
              '#6366f1',
              '#fb7185',
              '#94a3b8'
            ],
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              grid: {
                color: 'rgba(148, 163, 184, 0.2)'
              },
              ticks: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}h`;
                }
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}
