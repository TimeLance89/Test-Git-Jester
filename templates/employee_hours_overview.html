{% extends "layout.html" %}

{% block title %}Meine Stunden{% endblock %}

{% block content %}
<section class="hours-dashboard">
  <header class="hours-hero">
    <div class="hours-hero-main">
      <p class="hours-hero-eyebrow">Hallo {{ employee.name }}</p>
      <h1>Ihre persönliche Stundenübersicht</h1>
      <p class="hours-hero-subtitle">
        Behalten Sie Ihre Fortschritte im Blick, vergleichen Sie vergangene Monate und erhalten Sie hilfreiche Hinweise für Ihren nächsten Einsatz.
      </p>
      <div class="hours-hero-meta">
        <div class="hours-trend-pill {{ 'trend-up' if trend_direction == 'up' else 'trend-down' if trend_direction == 'down' else 'trend-steady' }}">
          {% if trend_direction == 'up' %}
            <span aria-hidden="true">⬆️</span>
            <span>+{{ "%.1f"|format(hours_delta) }}h gegenüber letztem Monat</span>
          {% elif trend_direction == 'down' %}
            <span aria-hidden="true">⬇️</span>
            <span>{{ "%.1f"|format(hours_delta) }}h gegenüber letztem Monat</span>
          {% else %}
            <span aria-hidden="true">➖</span>
            <span>Stabile Arbeitszeit gegenüber letztem Monat</span>
          {% endif %}
        </div>
        <div class="hours-trend-pill pace-{{ pace_state }}">
          {% if pace_state == 'ahead' %}
            <span aria-hidden="true">⚡</span>
            <span>Sie liegen {{ "%.1f"|format(delta_vs_expected) }}h vor Ihrem Tagesziel</span>
          {% elif pace_state == 'behind' %}
            <span aria-hidden="true">⏳</span>
            <span>Es fehlen {{ "%.1f"|format(delta_vs_expected|abs) }}h zum Tagesziel</span>
          {% else %}
            <span aria-hidden="true">🎯</span>
            <span>Sie sind im Plan für diesen Monat</span>
          {% endif %}
        </div>
      </div>
      <div class="hours-hero-actions">
        <a class="hours-action primary" href="{{ url_for('schedule') }}">
          <span class="hours-action-icon" aria-hidden="true">📅</span>
          Dienstplan öffnen
        </a>
        <a class="hours-action" href="{{ url_for('leave_form') }}">
          <span class="hours-action-icon" aria-hidden="true">📝</span>
          Abwesenheit beantragen
        </a>
        <a class="hours-action" href="{{ url_for('employee_profile', emp_id=employee.id) }}">
          <span class="hours-action-icon" aria-hidden="true">👤</span>
          Profil ansehen
        </a>
      </div>
    </div>
    <aside class="hours-hero-side">
      <div class="hours-highlight">
        <span class="hours-highlight-icon" aria-hidden="true">🎉</span>
        <div>
          <p class="hours-highlight-title">{{ consecutive_goal_months }} Monate in Folge</p>
          <p class="hours-highlight-text">mit erreichten Monatszielen</p>
        </div>
      </div>
      <div class="hours-highlight secondary">
        <span class="hours-highlight-icon" aria-hidden="true">⏱️</span>
        <div>
          <p class="hours-highlight-title">Durchschnitt {{ "%.1f"|format(average_hours_per_shift) }}h</p>
          <p class="hours-highlight-text">pro Einsatz in diesem Monat</p>
        </div>
      </div>
      {% if average_hours_per_workday %}
      <div class="hours-highlight tertiary">
        <span class="hours-highlight-icon" aria-hidden="true">📆</span>
        <div>
          <p class="hours-highlight-title">Prognose: {{ projected_completion_label or 'Offen' }}</p>
          <p class="hours-highlight-text">Zuverlässigkeit: {{ projection_confidence or 'niedrig' }}</p>
        </div>
      </div>
      {% endif %}
    </aside>
  </header>

  <section class="hours-metric-grid" aria-label="Kennzahlen">
    <article class="hours-metric-card">
      <header>
        <span class="metric-icon" aria-hidden="true">🎯</span>
        <p class="metric-label">Soll-Stunden (Monat)</p>
      </header>
      <p class="metric-value">{{ "%.1f"|format(hours_summary.target_hours) }}<span>h</span></p>
      <p class="metric-helper">Ihre vertraglichen Stunden für {{ current_month }}/{{ current_year }}.</p>
    </article>
    <article class="hours-metric-card">
      <header>
        <span class="metric-icon" aria-hidden="true">📈</span>
        <p class="metric-label">Fortschritt</p>
      </header>
      <p class="metric-value">{{ "%.1f"|format(hours_summary.completion_percentage) }}<span>%</span></p>
      <p class="metric-helper">basierend auf den anteiligen Soll-Stunden.</p>
    </article>
    <article class="hours-metric-card">
      <header>
        <span class="metric-icon" aria-hidden="true">✅</span>
        <p class="metric-label">Geleistete Stunden</p>
      </header>
      <p class="metric-value">{{ "%.1f"|format(hours_summary.worked_hours) }}<span>h</span></p>
      <p class="metric-helper">bereits genehmigt und dokumentiert.</p>
    </article>
    <article class="hours-metric-card warning">
      <header>
        <span class="metric-icon" aria-hidden="true">🧭</span>
        <p class="metric-label">Offene Stunden</p>
      </header>
      <p class="metric-value">{{ "%.1f"|format(hours_summary.remaining_hours) }}<span>h</span></p>
      <p class="metric-helper">noch bis zum Erreichen der Monatsziele.</p>
    </article>
    {% if employee.position != 'Vollzeit' %}
    <article class="hours-metric-card accent">
      <header>
        <span class="metric-icon" aria-hidden="true">⚖️</span>
        <p class="metric-label">Überstunden</p>
      </header>
      <p class="metric-value">{{ "%.1f"|format(hours_summary.overtime_hours) }}<span>h</span></p>
      <p class="metric-helper">gegenüber den anteiligen Soll-Stunden.</p>
    </article>
    {% endif %}
    <article class="hours-metric-card neutral">
      <header>
        <span class="metric-icon" aria-hidden="true">🗓️</span>
        <p class="metric-label">Schichten</p>
      </header>
      <p class="metric-value">{{ hours_summary.shift_count }}</p>
      <p class="metric-helper">geplante &amp; genehmigte Einsätze im Monat.</p>
    </article>
  </section>

  <section class="hours-insights" aria-label="Insights">
    <div class="hours-insight-grid">
      <article class="hours-insight-card">
        <header>
          <span class="insight-icon" aria-hidden="true">📊</span>
          <div>
            <p class="insight-eyebrow">Fokus-Tag</p>
            <h2>{{ weekday_insight.name if weekday_insight else 'Noch keine Daten' }}</h2>
          </div>
        </header>
        {% if weekday_insight %}
        <p class="insight-text">{{ "%.1f"|format(weekday_insight.hours) }}h ({{ "%.0f"|format(weekday_insight.share) }}% Ihrer Stunden) fallen auf den {{ weekday_insight.name }}.</p>
        {% else %}
        <p class="insight-text">Sobald Schichten erfasst werden, sehen Sie hier den stärksten Wochentag.</p>
        {% endif %}
      </article>
      <article class="hours-insight-card">
        <header>
          <span class="insight-icon" aria-hidden="true">🧠</span>
          <div>
            <p class="insight-eyebrow">Schichtarten</p>
            <h2>Top-Einsätze</h2>
          </div>
        </header>
        {% if shift_type_highlights %}
        <ul class="insight-list">
          {% for highlight in shift_type_highlights[:3] %}
          <li>
            <span>{{ highlight.label }}</span>
            <span>{{ "%.1f"|format(highlight.hours) }}h · {{ "%.0f"|format(highlight.share) }}%</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="insight-text">Hier sehen Sie bald, welche Schichtarten den größten Anteil ausmachen.</p>
        {% endif %}
      </article>
      <article class="hours-insight-card">
        <header>
          <span class="insight-icon" aria-hidden="true">🌟</span>
          <div>
            <p class="insight-eyebrow">Motivation</p>
            <h2>Ihre Lernkurve</h2>
          </div>
        </header>
        <p class="insight-text">Sie haben {{ goal_history|length }} Monate dokumentiert und {{ consecutive_goal_months }} davon hintereinander mit Zielerreichung abgeschlossen.</p>
        <div class="goal-history">
          {% for entry in goal_history_recent %}
          <div class="goal-history-item {{ 'reached' if entry.reached else '' }}">
            <span class="goal-history-label">{{ entry.label }}</span>
            <span class="goal-history-value">{{ "%.0f"|format(entry.worked) }} / {{ "%.0f"|format(entry.target) }}h</span>
          </div>
          {% endfor %}
        </div>
      </article>
    </div>
  </section>

  <section class="hours-chart-grid" aria-label="Visualisierungen">
    <article class="chart-card">
      <header>
        <div>
          <p class="chart-eyebrow">Verlauf</p>
          <h2>Stundenentwicklung (12 Monate)</h2>
        </div>
      </header>
      <canvas id="monthlyHoursChart" aria-label="Säulendiagramm für Stundenentwicklung" role="img"></canvas>
    </article>
    <article class="chart-card">
      <header>
        <div>
          <p class="chart-eyebrow">Wochentage</p>
          <h2>Arbeitsverteilung</h2>
        </div>
      </header>
      <canvas id="weekdayHoursChart" aria-label="Tortendiagramm für Wochentage" role="img"></canvas>
    </article>
    <article class="chart-card">
      <header>
        <div>
          <p class="chart-eyebrow">Schichtarten</p>
          <h2>Verhältnis nach Typ</h2>
        </div>
      </header>
      <canvas id="shiftTypeHoursChart" aria-label="Donut-Diagramm für Schichtarten" role="img"></canvas>
    </article>
  </section>

  <section class="hours-detail-grid">
    <article class="detail-card">
      <header class="detail-card-header">
        <div>
          <p class="detail-eyebrow">Planung</p>
          <h2>Kommende Einsätze</h2>
        </div>
        <a class="detail-link" href="{{ url_for('schedule') }}">Dienstplan anzeigen</a>
      </header>
      {% if upcoming_shifts %}
      <ul class="hours-schedule-list">
        {% for shift in upcoming_shifts %}
        <li>
          <div>
            <p class="schedule-title">{{ shift.shift_type or 'Schicht' }}</p>
            <p class="schedule-meta">{{ shift.date.strftime('%A, %d.%m.%Y') }}</p>
          </div>
          <span class="schedule-hours">{{ "%.1f"|format(shift.hours) }}h</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="detail-empty">Keine kommenden Einsätze geplant.</p>
      {% endif %}
    </article>
    <article class="detail-card">
      <header class="detail-card-header">
        <div>
          <p class="detail-eyebrow">Aktueller Monat</p>
          <h2>Geleistete Schichten</h2>
        </div>
      </header>
      {% if hours_summary.shifts_detail %}
      <div class="table-wrapper">
        <table class="hours-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Stunden</th>
              <th>Schichtart</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for shift in hours_summary.shifts_detail %}
            <tr>
              <td>{{ shift.date.strftime('%d.%m.%Y') }}</td>
              <td>{{ "%.1f"|format(shift.hours) }}h</td>
              <td>{{ shift.shift_type or 'N/A' }}</td>
              <td>
                <span class="status-chip {{ 'status-positive' if shift.approved else 'status-pending' }}">
                  {% if shift.approved %}Genehmigt{% else %}Ausstehend{% endif %}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="detail-empty">Noch keine Einsätze im aktuellen Monat erfasst.</p>
      {% endif %}
    </article>
    <article class="detail-card">
      <header class="detail-card-header">
        <div>
          <p class="detail-eyebrow">Abwesenheiten</p>
          <h2>Übersicht</h2>
        </div>
        <a class="detail-link" href="{{ url_for('leave_form') }}">Neue Abwesenheit</a>
      </header>
      {% if recent_leaves %}
      <div class="table-wrapper">
        <table class="hours-table">
          <thead>
            <tr>
              <th>Von</th>
              <th>Bis</th>
              <th>Typ</th>
              <th>Genehmigt</th>
            </tr>
          </thead>
          <tbody>
            {% for leave in recent_leaves %}
            <tr>
              <td>{{ leave.start_date.strftime('%d.%m.%Y') }}</td>
              <td>{{ leave.end_date.strftime('%d.%m.%Y') }}</td>
              <td>{{ leave.leave_type }}</td>
              <td>
                <span class="status-chip {{ 'status-positive' if leave.approved else 'status-pending' }}">
                  {% if leave.approved %}Ja{% else %}Nein{% endif %}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="detail-empty">Keine Abwesenheiten in diesem Monat.</p>
      {% endif %}
    </article>
  </section>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const root = getComputedStyle(document.documentElement);
    const primaryColor = root.getPropertyValue('--primary-color').trim() || '#2563eb';
    const secondaryColor = root.getPropertyValue('--secondary-color').trim() || '#64748b';
    const surfaceColor = root.getPropertyValue('--surface-color').trim() || '#ffffff';
    const borderColor = root.getPropertyValue('--border-color').trim() || '#e2e8f0';

    const monthlyCtx = document.getElementById('monthlyHoursChart');
    if (monthlyCtx) {
      const monthlyData = {{ monthly_data | tojson }};
      const monthlyLabels = monthlyData.map(data => data.month_year);
      const monthlyWorkedHours = monthlyData.map(data => data.worked_hours);
      const monthlyTargetHours = monthlyData.map(data => data.target_hours);
      const monthlyProportionalTarget = monthlyData.map(data => data.proportional_target);

      new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthlyLabels,
          datasets: [
            {
              label: 'Geleistete Stunden',
              data: monthlyWorkedHours,
              backgroundColor: primaryColor,
              borderRadius: 6,
              maxBarThickness: 36
            },
            {
              label: 'Soll-Stunden',
              data: monthlyTargetHours,
              type: 'line',
              borderColor: secondaryColor,
              backgroundColor: secondaryColor,
              pointRadius: 4,
              tension: 0.35,
              borderWidth: 2
            },
            {
              label: 'Anteilige Soll-Stunden',
              data: monthlyProportionalTarget,
              type: 'line',
              borderColor: '#f59e0b',
              backgroundColor: '#f59e0b',
              pointRadius: 3,
              tension: 0.35,
              borderDash: [4, 4],
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                boxWidth: 12
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y + 'h';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: borderColor
              },
              ticks: {
                callback: value => value + 'h'
              }
            }
          }
        }
      });
    }

    const weekdayCtx = document.getElementById('weekdayHoursChart');
    if (weekdayCtx) {
      const weekdayHours = {{ weekday_hours | tojson }};
      const weekdayLabels = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
      const weekdayData = weekdayLabels.map((_, index) => weekdayHours[index] || 0);

      new Chart(weekdayCtx, {
        type: 'doughnut',
        data: {
          labels: weekdayLabels,
          datasets: [{
            data: weekdayData,
            backgroundColor: [
              primaryColor,
              '#10b981',
              '#f59e0b',
              '#6366f1',
              '#ec4899',
              '#14b8a6',
              '#94a3b8'
            ],
            borderColor: surfaceColor,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.parsed;
                  return `${context.label}: ${value}h`;
                }
              }
            }
          }
        }
      });
    }

    const shiftTypeCtx = document.getElementById('shiftTypeHoursChart');
    if (shiftTypeCtx) {
      const shiftTypeHours = {{ shift_type_hours | tojson }};
      const shiftTypeLabels = Object.keys(shiftTypeHours);
      const shiftTypeData = Object.values(shiftTypeHours);

      new Chart(shiftTypeCtx, {
        type: 'polarArea',
        data: {
          labels: shiftTypeLabels,
          datasets: [{
            data: shiftTypeData,
            backgroundColor: [
              primaryColor,
              '#38bdf8',
              '#a855f7',
              '#f97316',
              '#22c55e',
              '#ef4444',
              '#0ea5e9'
            ],
            borderColor: surfaceColor,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              grid: {
                color: borderColor
              },
              ticks: {
                backdropColor: 'transparent',
                callback: (value) => value + 'h'
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 16
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return `${label}: ${value}h`;
                }
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}
