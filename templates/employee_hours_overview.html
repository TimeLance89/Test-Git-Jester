{% extends "layout.html" %}
{% block title %}Meine Stunden ¬∑ Einsatzplaner{% endblock %}

{% block content %}
<style>
  .hours-dashboard {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
    padding-bottom: 3rem;
  }

  .hours-hero {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1.75rem;
    padding: 2.25rem;
    border-radius: var(--radius-xl, 24px);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(99, 102, 241, 0.12));
    border: 1px solid rgba(37, 99, 235, 0.18);
    box-shadow: var(--shadow-md);
  }

  .hours-hero h1 {
    margin-bottom: 0.35rem;
    font-size: clamp(1.75rem, 3vw, 2.5rem);
    font-weight: 700;
    color: var(--text-primary);
  }

  .hours-hero .hero-subtitle {
    margin: 0;
    max-width: 60ch;
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .hours-hero-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    font-size: 0.95rem;
    color: var(--text-secondary);
  }

  .hours-hero-meta span {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 0.9rem;
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.25);
    backdrop-filter: blur(8px);
  }

  .hours-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
  }

  .summary-card {
    position: relative;
  }

  .summary-card::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), transparent 70%);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .summary-card:hover::after {
    opacity: 1;
  }

  .summary-meta {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .summary-meta span {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .hours-panel {
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    background: var(--surface-color);
    box-shadow: var(--shadow-sm);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .hours-panel-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
    align-items: center;
  }

  .hours-panel h2 {
    margin: 0;
    font-size: 1.35rem;
    color: var(--text-primary);
  }

  .hours-panel p {
    margin: 0;
    color: var(--text-secondary);
  }

  .progress-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .progress-bar {
    width: 100%;
    height: 0.8rem;
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.25);
    overflow: hidden;
  }

  .progress-bar span {
    display: block;
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.9), rgba(99, 102, 241, 0.9));
    transition: width 0.4s ease;
  }

  .progress-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.25rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .insight-list {
    display: grid;
    gap: 0.75rem;
  }

  .insight-item {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    padding: 0.85rem 1rem;
    border-radius: var(--radius-md);
    background: rgba(37, 99, 235, 0.08);
    border: 1px solid rgba(37, 99, 235, 0.18);
    color: var(--text-primary);
  }

  .insight-item strong {
    color: var(--primary-color);
    font-size: 1.1rem;
  }

  .data-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }

  .data-list {
    display: grid;
    gap: 0.65rem;
  }

  .data-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.6);
  }

  .data-list-item:last-child {
    border-bottom: none;
  }

  .data-list-item span:first-child {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .data-list-item span:last-child {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-weight: 600;
    color: var(--text-primary);
  }

  .data-list-item small {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .data-note {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .hours-table {
    width: 100%;
    border-collapse: collapse;
  }

  .hours-table thead {
    background: rgba(226, 232, 240, 0.45);
  }

  .hours-table th,
  .hours-table td {
    padding: 0.85rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(226, 232, 240, 0.7);
  }

  .hours-table tbody tr:hover {
    background: rgba(37, 99, 235, 0.06);
  }

  .hours-table td:last-child,
  .hours-table th:last-child {
    text-align: right;
  }

  .empty-hint {
    padding: 1rem 1.25rem;
    border-radius: var(--radius-md);
    border: 1px dashed rgba(148, 163, 184, 0.6);
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .hours-panel {
      padding: 1.5rem;
    }

    .hours-panel-header {
      align-items: flex-start;
    }

    .progress-meta {
      flex-direction: column;
      gap: 0.6rem;
    }
  }
</style>

<div class="hours-dashboard">
  <section class="hours-hero" aria-labelledby="hours-title">
    <div>
      <p class="hero-subtitle">Monat {{ "%02d"|format(current_month) }}/{{ current_year }}</p>
      <h1 id="hours-title">Hallo {{ employee.first_name }}!</h1>
      <p class="hero-subtitle">Hier findest du deine personalisierte √úbersicht √ºber geplante, geleistete und verbleibende Stunden.</p>
    </div>
    <div class="hours-hero-meta">
      <span>üë§ {{ employee.first_name }} {{ employee.last_name }}</span>
      {% if employee.position %}<span>üíº {{ employee.position }}</span>{% endif %}
      <span>üóìÔ∏è Vertrag: {{ "%.0f"|format(hours_summary.target_hours) }} h / Monat</span>
      <span>üìÖ Genehmigte Schichten: {{ hours_summary.shift_count }}</span>
    </div>
  </section>

  <section aria-label="Kennzahlen" class="hours-summary-grid">
    <article class="summary-card">
      <span class="summary-label">Monatliche Sollzeit</span>
      <span class="summary-value">{{ "%.1f"|format(hours_summary.target_hours) }} h</span>
      <p class="summary-description">Gesamte Vertragsstunden f√ºr diesen Monat.</p>
      <div class="summary-meta">
        <span>Arbeitstage: {{ hours_summary.total_workdays or '‚Äì' }}</span>
      </div>
    </article>

    <article class="summary-card">
      <span class="summary-label">Soll bis heute</span>
      <span class="summary-value">{{ "%.1f"|format(hours_summary.proportional_target) }} h</span>
      <p class="summary-description">Erwartete Stunden basierend auf bereits vergangenen Arbeitstagen.</p>
      <div class="summary-meta">
        <span>{{ hours_summary.workdays_passed }} von {{ hours_summary.total_workdays }} Arbeitstagen geleistet</span>
      </div>
    </article>

    <article class="summary-card">
      <span class="summary-label">Geleistet</span>
      <span class="summary-value">{{ "%.1f"|format(hours_summary.worked_hours) }} h</span>
      <p class="summary-description">Summe aller genehmigten Schichten im aktuellen Monat.</p>
      <div class="summary-meta">
        <span>{{ hours_summary.shift_count }} Schichten</span>
      </div>
    </article>

    <article class="summary-card">
      <span class="summary-label">Offene Stunden</span>
      <span class="summary-value">{{ "%.1f"|format(hours_summary.remaining_hours) }} h</span>
      <p class="summary-description">Noch zu leistende Stunden bis zum Erreichen des Monatsziels.</p>
      <div class="summary-meta">
        <span>{{ hours_summary.days_passed }} von {{ hours_summary.total_workdays }} Arbeitstagen vergangen</span>
      </div>
    </article>

    {% if employee.position != 'Vollzeit' %}
    <article class="summary-card">
      <span class="summary-label">√úberstunden</span>
      <span class="summary-value">{{ "%.1f"|format(hours_summary.overtime_hours) }} h</span>
      <p class="summary-description">Zeitguthaben √ºber das anteilige Soll hinaus.</p>
      <div class="summary-meta">
        <span>Fortschritt: {{ "%.1f"|format(completion_percentage) }} %</span>
      </div>
    </article>
    {% endif %}

    <article class="summary-card">
      <span class="summary-label">Abwesenheiten</span>
      <span class="summary-value">{{ hours_summary.leaves_detail|length }}</span>
      <p class="summary-description">Genehmigte Abwesenheiten im aktuellen Monat.</p>
      <div class="summary-meta">
        <span>Typen: {{ hours_summary.leaves_detail|map(attribute='leave_type')|unique|list|length }}</span>
      </div>
    </article>
  </section>

  <section class="hours-panel" aria-labelledby="progress-heading">
    <div class="hours-panel-header">
      <div>
        <h2 id="progress-heading">Fortschritt &amp; Fokus</h2>
        <p>Dein aktueller Stand im Vergleich zu den Soll-Stunden.</p>
      </div>
      <strong>{{ "%.1f"|format(completion_percentage) }} % erreicht</strong>
    </div>
    <div class="progress-wrapper">
      <div class="progress-bar" role="presentation">
        <span style="width: {{ "%.1f"|format(progress_percentage) }}%;"></span>
      </div>
      <div class="progress-meta">
        <span>Vergangene Arbeitstage: {{ hours_summary.workdays_passed }} / {{ hours_summary.total_workdays }}</span>
        <span>Aktueller Status: {% if hours_summary.remaining_hours > 0 %}Noch {{ "%.1f"|format(hours_summary.remaining_hours) }} Stunden offen{% else %}Ziel erreicht{% endif %}</span>
        {% if monthly_trend %}
        <span>
          Trend vs. letzter Monat:
          {% if monthly_trend.difference >= 0 %}‚ñ≤ +{{ "%.1f"|format(monthly_trend.difference) }} h{% else %}‚ñº {{ "%.1f"|format(monthly_trend.difference) }} h{% endif %}
        </span>
        {% endif %}
      </div>
    </div>
    <div class="insight-list" aria-label="Empfehlungen">
      {% for recommendation in recommendations %}
      <div class="insight-item">
        <strong>‚Ä¢</strong>
        <span>{{ recommendation }}</span>
      </div>
      {% endfor %}
    </div>
  </section>

  <section class="hours-panel" aria-labelledby="distribution-heading">
    <div class="hours-panel-header">
      <div>
        <h2 id="distribution-heading">Arbeitsverteilung</h2>
        <p>Wie verteilen sich deine Eins√§tze nach Wochentag und Schichtart?</p>
      </div>
    </div>
    <div class="data-grid">
      <div>
        <h3>Wochentage</h3>
        {% if weekday_breakdown %}
        <div class="data-list">
          {% for day in weekday_breakdown %}
          <div class="data-list-item">
            <span>{{ day.label }}</span>
            <span>
              {{ "%.1f"|format(day.hours) }} h
              <small>{{ "%.0f"|format(day.percentage) }} %</small>
            </span>
          </div>
          {% endfor %}
        </div>
        {% if top_weekday %}
        <p class="data-note">Meiste Stunden: {{ top_weekday.label }} ({{ "%.1f"|format(top_weekday.hours) }} h)</p>
        {% endif %}
        {% if calm_weekday %}
        <p class="data-note">Potenzial f√ºr mehr Eins√§tze: {{ calm_weekday.label }}.</p>
        {% endif %}
        {% else %}
        <p class="empty-hint">Noch keine genehmigten Schichten in diesem Monat.</p>
        {% endif %}
      </div>
      <div>
        <h3>Schichtarten</h3>
        {% if shift_breakdown %}
        <div class="data-list">
          {% for shift in shift_breakdown %}
          <div class="data-list-item">
            <span>{{ shift.type }}</span>
            <span>
              {{ "%.1f"|format(shift.hours) }} h
              <small>{{ "%.0f"|format(shift.percentage) }} %</small>
            </span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty-hint">Keine Schichtarten verf√ºgbar.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="hours-panel" aria-labelledby="history-heading">
    <div class="hours-panel-header">
      <div>
        <h2 id="history-heading">Monatsverlauf</h2>
        <p>Vergleich der letzten Monate inklusive Soll- und Ist-Stunden.</p>
      </div>
    </div>
    {% if recent_months %}
    <div class="table-responsive">
      <table class="hours-table">
        <thead>
          <tr>
            <th>Monat</th>
            <th>Geleistet</th>
            <th>Soll</th>
            <th>Abweichung</th>
          </tr>
        </thead>
        <tbody>
          {% for month in recent_months %}
          {% set delta = month.worked_hours - month.target_hours %}
          <tr>
            <td>{{ month.label }}</td>
            <td>{{ "%.1f"|format(month.worked_hours) }} h</td>
            <td>{{ "%.1f"|format(month.target_hours) }} h</td>
            <td>
              {% if delta > 0 %}+{{ "%.1f"|format(delta) }} h{% elif delta < 0 %}{{ "%.1f"|format(delta) }} h{% else %}Ausgeglichen{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="empty-hint">Noch keine historischen Daten vorhanden.</p>
    {% endif %}
  </section>

  <section class="hours-panel" aria-labelledby="shift-details-heading">
    <div class="hours-panel-header">
      <div>
        <h2 id="shift-details-heading">Geleistete Schichten</h2>
        <p>Alle genehmigten Eins√§tze des aktuellen Monats im √úberblick.</p>
      </div>
    </div>
    {% if hours_summary.shifts_detail %}
    <div class="table-responsive">
      <table class="hours-table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Stunden</th>
            <th>Schichtart</th>
            <th>Genehmigt</th>
          </tr>
        </thead>
        <tbody>
          {% for shift in hours_summary.shifts_detail %}
          <tr>
            <td>{{ shift.date.strftime('%d.%m.%Y') }}</td>
            <td>{{ "%.1f"|format(shift.hours) }} h</td>
            <td>{{ shift.shift_type or 'N/A' }}</td>
            <td>{% if shift.approved %}Ja{% else %}Nein{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="empty-hint">Keine geleisteten Schichten in diesem Monat.</p>
    {% endif %}
  </section>

  <section class="hours-panel" aria-labelledby="leave-details-heading">
    <div class="hours-panel-header">
      <div>
        <h2 id="leave-details-heading">Abwesenheiten</h2>
        <p>√úbersicht √ºber Urlaub, Krankheitstage und weitere Abwesenheiten.</p>
      </div>
    </div>
    {% if hours_summary.leaves_detail %}
    <div class="table-responsive">
      <table class="hours-table">
        <thead>
          <tr>
            <th>Startdatum</th>
            <th>Enddatum</th>
            <th>Typ</th>
            <th>Genehmigt</th>
            <th>Notizen</th>
          </tr>
        </thead>
        <tbody>
          {% for leave in hours_summary.leaves_detail %}
          <tr>
            <td>{{ leave.start_date.strftime('%d.%m.%Y') }}</td>
            <td>{{ leave.end_date.strftime('%d.%m.%Y') }}</td>
            <td>{{ leave.leave_type }}</td>
            <td>{% if leave.approved %}Ja{% else %}Nein{% endif %}</td>
            <td>{{ leave.notes or '‚Äì' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="empty-hint">Keine Abwesenheiten in diesem Monat.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
