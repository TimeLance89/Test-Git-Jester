{% extends "layout.html" %}
{% set super_admins = users | selectattr('is_admin') | selectattr('department_id', 'equalto', None) | list %}
{% set department_admins = users | selectattr('is_admin') | rejectattr('department_id', 'equalto', None) | list %}
{% set employees = users | rejectattr('is_admin') | list %}
{% block title %}Benutzerverwaltung - Xerxes{% endblock %}
{% block content %}
<section class="user-management-page">
  <header class="page-header">
    <div class="page-header-main">
      <div class="page-header-icon">👥</div>
      <div>
        <h1>Benutzerverwaltung</h1>
        <p>Administrator-Rechte und Benutzerrollen verwalten</p>
      </div>
    </div>
    <div class="page-header-meta">
      <span class="meta-pill">
        <span class="meta-icon">🔐</span>
        {{ users|length }} aktive Benutzer
      </span>
      <span class="meta-pill">
        <span class="meta-icon">🏢</span>
        {{ departments|length }} Abteilungen
      </span>
      <span class="meta-pill meta-pill--highlight">
        <span class="meta-icon">🔥</span>
        {{ super_admins|length }} Super-Admins
      </span>
    </div>
  </header>

  <section class="card-modern">
    <div class="card-modern-header">
      <div>
        <h2>Rollen im Überblick</h2>
        <p>Verstehen Sie die Unterschiede zwischen den Berechtigungsstufen.</p>
      </div>
    </div>
    <div class="role-grid">
      <article class="role-card role-card--super">
        <header>
          <span class="role-icon">🔥</span>
          <h3>Super-Administrator</h3>
        </header>
        <p>Vollzugriff auf das System – ideal für zentrale Administratoren.</p>
        <ul>
          <li>Verwaltet alle Abteilungen und Einstellungen</li>
          <li>Erstellt neue Abteilungen und Administratoren</li>
          <li>Kann alle Benutzerrechte anpassen</li>
        </ul>
      </article>
      <article class="role-card role-card--department">
        <header>
          <span class="role-icon">🏢</span>
          <h3>Abteilungsadministrator</h3>
        </header>
        <p>Fokussierte Rechte für die Steuerung einer Abteilung.</p>
        <ul>
          <li>Verwaltet Mitarbeiter der eigenen Abteilung</li>
          <li>Erstellt und bearbeitet Dienstpläne</li>
          <li>Genehmigt Abwesenheiten für das Team</li>
        </ul>
      </article>
      <article class="role-card role-card--employee">
        <header>
          <span class="role-icon">👤</span>
          <h3>Mitarbeiter</h3>
        </header>
        <p>Transparenter Zugriff auf eigene Daten und Anträge.</p>
        <ul>
          <li>Sieht persönliche Daten und Dienstpläne</li>
          <li>Beantragt Abwesenheiten digital</li>
          <li>Bleibt über Teamkollegen informiert</li>
        </ul>
      </article>
    </div>
  </section>

  <section class="card-modern">
    <div class="card-modern-header">
      <div>
        <h2>Alle Benutzer</h2>
        <p>Steuern Sie Rollen und Abteilungszuordnungen an einem Ort.</p>
      </div>
      <div class="card-modern-meta">
        <span class="badge-pill">{{ super_admins|length }} Super-Admins</span>
        <span class="badge-pill">{{ department_admins|length }} Abteilungs-Admins</span>
        <span class="badge-pill">{{ employees|length }} Mitarbeiter</span>
      </div>
    </div>

    {% if users %}
    <div class="table-scroll">
      <table class="table-modern">
        <thead>
          <tr>
            <th>Name</th>
            <th>Benutzername</th>
            <th>E-Mail</th>
            <th>Abteilung</th>
            <th>Status</th>
            <th class="text-center">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td class="user-name">{{ user.name }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email or '–' }}</td>
            <td>
              {% if user.department %}
                <span class="department-chip">
                  {% if user.department.color %}
                    <span class="department-dot" style="background-color: {{ user.department.color }};"></span>
                  {% endif %}
                  {{ user.department.name }}
                </span>
              {% else %}
                <span class="department-chip department-chip--global">🌟 Alle Abteilungen</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_admin and not user.department_id %}
                <span class="role-badge role-badge--super">🔥 Super-Admin</span>
              {% elif user.is_admin and user.department_id %}
                <span class="role-badge role-badge--department">🏢 Abteilungs-Admin</span>
              {% else %}
                <span class="role-badge role-badge--employee">👤 Mitarbeiter</span>
              {% endif %}
            </td>
            <td>
              {% if not session.get('department_id') %}
                <div class="user-actions">
                  {% if not (user.is_admin and not user.department_id) %}
                  <form method="post" action="{{ url_for('make_user_super_admin', user_id=user.id) }}">
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('{{ user.name }} zum Super-Administrator mit Vollzugriff machen?')">
                      🔥 Super-Admin
                    </button>
                  </form>
                  {% endif %}

                  {% if not user.is_admin or not user.department_id %}
                  <div class="dropdown">
                    <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      🏢 Abteilungs-Admin
                    </button>
                    <ul class="dropdown-menu">
                      {% for dept in departments %}
                      <li>
                        <form method="post" action="{{ url_for('make_user_department_admin', user_id=user.id) }}">
                          <input type="hidden" name="department_id" value="{{ dept.id }}">
                          <button type="submit" class="dropdown-item"
                                  onclick="return confirm('{{ user.name }} zum Administrator von {{ dept.name }} machen?')">
                            {% if dept.color %}
                              <span class="department-dot" style="background-color: {{ dept.color }};"></span>
                            {% endif %}
                            {{ dept.name }}
                          </button>
                        </form>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}

                  {% if user.is_admin %}
                  <form method="post" action="{{ url_for('remove_user_admin', user_id=user.id) }}">
                    <button type="submit" class="btn btn-outline-secondary btn-sm"
                            onclick="return confirm('Administrator-Rechte von {{ user.name }} entfernen?')">
                      ❌ Rechte entfernen
                    </button>
                  </form>
                  {% endif %}
                </div>
              {% else %}
                <span class="user-actions-hint">Nur Super-Admins können Benutzerrollen ändern</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">👥</div>
      <h3>Keine Benutzer gefunden</h3>
      <p>Es sind noch keine Benutzer im System registriert.</p>
    </div>
    {% endif %}
  </section>

  {% if not session.get('department_id') %}
  <aside class="admin-warning">
    <span class="admin-warning-icon">⚠️</span>
    <div>
      <h3>Wichtiger Hinweis</h3>
      <p>
        Als Super-Administrator haben Sie die Möglichkeit, Benutzerrollen zu ändern.
        Stellen Sie sicher, dass immer mindestens ein Super-Administrator im System vorhanden ist.
        Sie können sich nicht selbst degradieren, wenn Sie der einzige Super-Administrator sind.
      </p>
    </div>
  </aside>
  {% endif %}
</section>
{% endblock %}
