{% extends "layout.html" %}
{% block title %}Benutzerverwaltung - Dienstplaner{% endblock %}
{% block content %}
<div style="margin-bottom: 2rem;">
  <h1 style="display: flex; align-items: center; margin-bottom: 0.5rem;">
    <span style="margin-right: 0.75rem; font-size: 2rem;">👥</span>
    Benutzerverwaltung
  </h1>
  <p style="color: #64748b; font-size: 1.125rem; margin: 0;">Administrator-Rechte und Benutzerrollen verwalten</p>
</div>

<!-- Hilfe-Bereich (nach oben verschoben) -->
<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">
    <h4 style="margin: 0; display: flex; align-items: center;">
      <span style="margin-right: 0.75rem;">💡</span>
      Benutzerrollen Erklärung
    </h4>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <div style="padding: 1rem; border: 2px solid #dc2626; border-radius: 0.5rem; margin-bottom: 1rem;">
          <h5 style="color: #dc2626; margin-bottom: 0.5rem;">🔥 Super-Administrator</h5>
          <ul style="margin: 0; padding-left: 1.5rem; color: #374151;">
            <li>Vollzugriff auf alle Abteilungen</li>
            <li>Kann neue Abteilungen erstellen</li>
            <li>Kann alle Benutzer verwalten</li>
            <li>Kann andere zu Admins machen</li>
          </ul>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding: 1rem; border: 2px solid #3b82f6; border-radius: 0.5rem; margin-bottom: 1rem;">
          <h5 style="color: #3b82f6; margin-bottom: 0.5rem;">🏢 Abteilungsadministrator</h5>
          <ul style="margin: 0; padding-left: 1.5rem; color: #374151;">
            <li>Zugriff nur auf eigene Abteilung</li>
            <li>Kann Mitarbeiter der Abteilung verwalten</li>
            <li>Kann Dienstpläne erstellen</li>
            <li>Kann Abwesenheiten genehmigen</li>
          </ul>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding: 1rem; border: 2px solid #6b7280; border-radius: 0.5rem; margin-bottom: 1rem;">
          <h5 style="color: #6b7280; margin-bottom: 0.5rem;">👤 Mitarbeiter</h5>
          <ul style="margin: 0; padding-left: 1.5rem; color: #374151;">
            <li>Kann eigene Daten einsehen</li>
            <li>Kann Abwesenheiten beantragen</li>
            <li>Sieht Kollegen der eigenen Abteilung</li>
            <li>Kann eigenen Dienstplan einsehen</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Benutzer-Tabelle -->
<div class="card">
  <div class="card-header">
    <h3 style="margin: 0; display: flex; align-items: center;">
      <span style="margin-right: 0.75rem;">🔐</span>
      Alle Benutzer ({{ users|length }})
    </h3>
  </div>
  <div class="card-body" style="padding: 0;">
    {% if users %}
    <div style="overflow-x: auto;">
      <table class="table" style="margin: 0;">
        <thead>
          <tr>
            <th style="padding: 1.5rem 1rem;">
              <span style="margin-right: 0.5rem;">👤</span>Name
            </th>
            <th style="padding: 1.5rem 1rem;">
              <span style="margin-right: 0.5rem;">🔑</span>Benutzername
            </th>
            <th style="padding: 1.5rem 1rem;">
              <span style="margin-right: 0.5rem;">📧</span>E-Mail
            </th>
            <th style="padding: 1.5rem 1rem;">
              <span style="margin-right: 0.5rem;">🏢</span>Abteilung
            </th>
            <th style="padding: 1.5rem 1rem;">
              <span style="margin-right: 0.5rem;">⭐</span>Status
            </th>
            <th style="padding: 1.5rem 1rem; text-align: center;">
              <span style="margin-right: 0.5rem;">⚙️</span>Aktionen
            </th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td style="padding: 1rem; font-weight: 600;">{{ user.name }}</td>
            <td style="padding: 1rem;">{{ user.username }}</td>
            <td style="padding: 1rem;">{{ user.email or '–' }}</td>
            <td style="padding: 1rem;">
              {% if user.department %}
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  {% if user.department.color %}
                    <div style="width: 12px; height: 12px; border-radius: 50%; background-color: {{ user.department.color }};"></div>
                  {% endif %}
                  {{ user.department.name }}
                </span>
              {% else %}
                <span style="color: #f59e0b; font-weight: 600;">🌟 Alle Abteilungen</span>
              {% endif %}
            </td>
            <td style="padding: 1rem;">
              {% if user.is_admin and not user.department_id %}
                <span style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600;">
                  🔥 Super-Admin
                </span>
              {% elif user.is_admin and user.department_id %}
                <span style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600;">
                  🏢 Abteilungs-Admin
                </span>
              {% else %}
                <span style="background: linear-gradient(135deg, #6b7280, #9ca3af); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600;">
                  👤 Mitarbeiter
                </span>
              {% endif %}
            </td>
            <td style="padding: 1rem; text-align: center;">
              {% if not session.get('department_id') %}
                <!-- Nur Super-Admins sehen diese Aktionen -->
                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                  
                  {% if not (user.is_admin and not user.department_id) %}
                    <!-- Zu Super-Admin machen -->
                    <form method="post" action="{{ url_for('make_user_super_admin', user_id=user.id) }}" style="display: inline;">
                      <button type="submit" class="btn btn-danger btn-sm" 
                              onclick="return confirm('{{ user.name }} zum Super-Administrator mit Vollzugriff machen?')"
                              style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        🔥 Super-Admin
                      </button>
                    </form>
                  {% endif %}
                  
                  {% if not user.is_admin or not user.department_id %}
                    <!-- Zu Abteilungs-Admin machen -->
                    <div class="dropdown" style="display: inline;">
                      <button class="btn btn-primary btn-sm dropdown-toggle" type="button" 
                              data-bs-toggle="dropdown" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        🏢 Abteilungs-Admin
                      </button>
                      <ul class="dropdown-menu">
                        {% for dept in departments %}
                        <li>
                          <form method="post" action="{{ url_for('make_user_department_admin', user_id=user.id) }}" style="margin: 0;">
                            <input type="hidden" name="department_id" value="{{ dept.id }}">
                            <button type="submit" class="dropdown-item" 
                                    onclick="return confirm('{{ user.name }} zum Administrator von {{ dept.name }} machen?')">
                              {% if dept.color %}
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: {{ dept.color }}; margin-right: 0.5rem;"></span>
                              {% endif %}
                              {{ dept.name }}
                            </button>
                          </form>
                        </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                  
                  {% if user.is_admin %}
                    <!-- Admin-Rechte entfernen -->
                    <form method="post" action="{{ url_for('remove_user_admin', user_id=user.id) }}" style="display: inline;">
                      <button type="submit" class="btn btn-outline-secondary btn-sm" 
                              onclick="return confirm('Administrator-Rechte von {{ user.name }} entfernen?')"
                              style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        ❌ Rechte entfernen
                      </button>
                    </form>
                  {% endif %}
                  
                </div>
              {% else %}
                <!-- Abteilungsadmins sehen nur Info -->
                <span style="color: #6b7280; font-size: 0.875rem;">
                  Nur Super-Admins können Benutzerrollen ändern
                </span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #6b7280;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
      <h4>Keine Benutzer gefunden</h4>
      <p>Es sind noch keine Benutzer im System registriert.</p>
    </div>
    {% endif %}
  </div>
</div>

{% if not session.get('department_id') %}
<!-- Warnung für Super-Admins -->
<div class="alert alert-warning" style="margin-top: 2rem;">
  <h5 style="margin-bottom: 0.5rem;">⚠️ Wichtiger Hinweis</h5>
  <p style="margin: 0;">
    Als Super-Administrator haben Sie die Macht, Benutzerrollen zu ändern. 
    Stellen Sie sicher, dass immer mindestens ein Super-Administrator im System vorhanden ist.
    Sie können sich nicht selbst degradieren, wenn Sie der einzige Super-Administrator sind.
  </p>
</div>
{% endif %}

{% endblock %}

