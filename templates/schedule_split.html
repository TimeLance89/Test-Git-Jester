{% extends "layout.html" %}
{% block title %}Dienstplan{% endblock %}
{% block content %}

<h2>Dienstplan für {{ month }}.{{ year }}</h2>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-2">
    <label class="form-label" for="month">Monat</label>
    <select class="form-select" id="month" name="month">
      {% for m in range(1, 13) %}
      <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label" for="year">Jahr</label>
    <select class="form-select" id="year" name="year">
      {% for y in range(2020, 2030) %}
      <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label" for="department">Abteilung</label>
    <select class="form-select" id="department" name="department">
      <option value="">Alle</option>
      {% for dept in departments %}
      <option value="{{ dept.id }}" {% if dept.id == selected_department %}selected{% endif %}>{{ dept.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100">Aktualisieren</button>
  </div>
</form>

<!-- Dienstplan mit geteiltem Layout -->
<div class="schedule-container">
  <!-- Linker Block: Mitarbeiternamen (fixiert) -->
  <div class="employees-column">
    <div class="employees-header">
      <div class="employee-header-cell">MITARBEITER</div>
      <div class="employee-header-cell-small">&nbsp;</div>
    </div>
    <div class="employees-list">
      {% for emp in employees %}
      <div class="employee-row">
        <a href="{{ url_for('employee_profile', emp_id=emp.id) }}" class="employee-name">
          {{ emp.name }}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Rechter Block: Scrollbare Monatsdaten -->
  <div class="schedule-data">
    <div class="table-responsive">
      <table class="table schedule-table align-middle">
        <thead>
          <tr>
            {% for day in month_days %}
            <th class="text-center">
              {{ day.day }}
              {% set day_data = productivity_data.get(day, {}) %}
              {% if day_data.get("teile", 0) > 0 %}
              <br><small class="productivity-info" 
                       title="Berechnung für {{ day.strftime('%d.%m.%Y') }}:&#10;Std Aushilfen + ZA: {{ day_data.get('aushilfen_za_std', 0) }}h&#10;Std Feste: {{ day_data.get('feste_std', 0) }}h&#10;Gesamt: {{ day_data.get('gesamt_std', 0) }}h&#10;Produktivität: {{ day_data.get('produktivitaet', 0) }}&#10;Teile: {{ day_data.get('gesamt_std', 0) }} × {{ day_data.get('produktivitaet', 0) }} = {{ day_data.get('teile', 0) }}"
                       style="color: #059669; font-weight: bold; cursor: help;">
                ({{ day_data.get("teile", 0)|int }} TEILE)
              </small>
              {% endif %}
            </th>
            {% endfor %}
            <th class="text-center">Σ</th>
          </tr>
          <tr>
            {% for day in month_days %}
            <th class="text-center"><small>{{ calendar.day_name[day.weekday()][:2] }}</small></th>
            {% endfor %}
            <th class="text-center"><small>Σ</small></th>
          </tr>
        </thead>
        <tbody>
          {% for emp in employees %}
          <tr>
            {% for day in month_days %}
            {% set leave = leaves.get((emp.id, day)) %}
            {% set shift = shifts.get((emp.id, day)) %}
            <td class="text-center">
              {% if leave %}
                <div class="schedule-cell leave" title="Abwesenheit: {{ leave.leave_type }}">
                  {{ leave.leave_type[:2] }}
                  <button type="button" class="btn-close btn-close-sm" onclick="deleteLeave({{ leave.id }})" title="Löschen"></button>
                </div>
              {% elif shift %}
                <div class="schedule-cell shift" title="Schicht: {{ shift.hours }}h{% if shift.shift_type %} ({{ shift.shift_type }}){% endif %}">
                  {{ shift.hours }}h
                  {% if shift.shift_type %}<br><small>{{ shift.shift_type }}</small>{% endif %}
                  <button type="button" class="btn-close btn-close-sm" onclick="deleteShift({{ shift.id }})" title="Löschen"></button>
                </div>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-center">
              <strong>{{ employee_totals.get(emp.id, 0) }} / {{ emp.monthly_hours or 0 }}</strong>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<h4 class="mt-5">Einsatz hinzufügen</h4>
<form method="post" action="{{ url_for('add_shift') }}" class="row g-3">
  <div class="col-md-3">
    <label class="form-label" for="employee_id">Mitarbeiter*</label>
    <select class="form-select" id="employee_id" name="employee_id" required>
      <option value="">Mitarbeiter auswählen</option>
      {% for emp in employees %}
      <option value="{{ emp.id }}">{{ emp.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label" for="date">Datum*</label>
    <input type="date" class="form-control" id="date" name="date" required />
  </div>
  <div class="col-md-2">
    <label class="form-label" for="hours">Stunden*</label>
    <input type="number" step="0.5" class="form-control" id="hours" name="hours" required />
  </div>
  <div class="col-md-3">
    <label class="form-label" for="shift_type">Typ</label>
    <input type="text" class="form-control" id="shift_type" name="shift_type" placeholder="z.B. Früh, Spät" />
  </div>
  <div class="col-md-1 d-flex align-items-end">
    <button type="submit" class="btn btn-success w-100">Hinzufügen</button>
  </div>
</form>

{% endblock %}

<script>
function deleteShift(shiftId) {
  if (confirm('Einsatz wirklich löschen?')) {
    window.location.href = '/einsatz/loeschen/' + shiftId;
  }
}

function deleteLeave(leaveId) {
  if (confirm('Abwesenheit wirklich löschen?')) {
    window.location.href = '/abwesenheit/loeschen/' + leaveId;
  }
}
</script>

